<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* ========== Theme CSS Variables ========== */
        :root {
            --bg-page: #ffffff;
            --bg-sidebar: #fbfbfd;
            --bg-chat: #fff;
            --bg-input: #ffffff;
            --bg-card: #ffffff;
            --bg-hover: #f3f4f6;
            --bg-active: #e5e7eb;
            --bg-muted: #f9fafb;
            --bg-code: #f3f4f6;
            --bg-modal: #fff;
            --bg-header-btn: #f3f4f6;
            --text-primary: #0f1724;
            --text-heading: #0b1220;
            --text-secondary: #374151;
            --text-muted: #6b7280;
            --text-placeholder: #9ca3af;
            --border-primary: #eef2f7;
            --border-secondary: #e5e7eb;
            --border-muted: #d1d5db;
            --shadow-sm: rgba(0,0,0,0.04);
            --shadow-md: rgba(0,0,0,0.08);
            --shadow-lg: rgba(0,0,0,0.12);
            --shadow-xl: rgba(0,0,0,0.15);
            --bg-user-avatar: #eef2f7;
            --bg-sources: #f9fafb;
            --bg-source-item: white;
            --bg-citation-full: #f9fafb;
            --bg-analytics: #f9fafb;
            --bg-analytics-card: #fff;
            --bg-table-th: #f9fafb;
            --bg-processing-stat: #f9fafb;
            --bg-input-container: #ffffff;
            --bg-doc-chip: #ffffff;
            --bg-carousel-btn: rgba(255,255,255,0.95);
            --bg-doc-chip-remove: rgba(255,255,255,0.9);
            --send-btn-bg: #0b1220;
            --send-btn-disabled-bg: #f3f4f6;
            --send-btn-disabled-color: #9ca3af;
            --scrollbar-thumb: #d1d5db;
            --color-scheme: light;
        }

        [data-theme="dark"] {
            --bg-page: #0f172a;
            --bg-sidebar: #1e293b;
            --bg-chat: #0f172a;
            --bg-input: #1e293b;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --bg-active: #475569;
            --bg-muted: #1e293b;
            --bg-code: #334155;
            --bg-modal: #1e293b;
            --bg-header-btn: #334155;
            --text-primary: #e2e8f0;
            --text-heading: #e2e8f0;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-placeholder: #64748b;
            --border-primary: #334155;
            --border-secondary: #334155;
            --border-muted: #475569;
            --shadow-sm: rgba(0,0,0,0.2);
            --shadow-md: rgba(0,0,0,0.3);
            --shadow-lg: rgba(0,0,0,0.4);
            --shadow-xl: rgba(0,0,0,0.5);
            --bg-user-avatar: #334155;
            --bg-sources: #1e293b;
            --bg-source-item: #1e293b;
            --bg-citation-full: #1e293b;
            --bg-analytics: #0f172a;
            --bg-analytics-card: #1e293b;
            --bg-table-th: #1e293b;
            --bg-processing-stat: #1e293b;
            --bg-input-container: #1e293b;
            --bg-doc-chip: #1e293b;
            --bg-carousel-btn: rgba(30,41,59,0.95);
            --bg-doc-chip-remove: rgba(30,41,59,0.9);
            --send-btn-bg: #334155;
            --send-btn-disabled-bg: #1e293b;
            --send-btn-disabled-color: #64748b;
            --scrollbar-thumb: #475569;
            --color-scheme: dark;
        }

        /* Base typography inspired by Claude but not identical */
        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 16px;
            background: var(--bg-page);
            height: 100vh;
            display: flex;
            color: var(--text-primary);
            color-scheme: var(--color-scheme);
        }

        /* Sidebar - Claude style */
        .sidebar {
            width: 240px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-primary);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-secondary);
        }

        .sidebar-header h2 {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-heading);
            letter-spacing: -0.01em;
        }

        .new-btn {
            width: 100%;
            padding: 10px 12px;
            margin-top: 12px;
            background: #ff8a00; /* project orange */
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.12s ease, background 0.12s;
        }
        .new-btn:hover { transform: translateY(-1px); background: #d97706; }

        /* Project List */
        .projects-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .project-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 6px;
            transition: background 0.12s;
            position: relative;
        }
        .project-item:hover { background: var(--bg-hover); }
        .project-item.active { background: var(--bg-active); }

        .project-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-heading);
        }

        .project-meta {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Conversations */
        .conversations {
            padding-left: 12px;
            margin-top: 4px;
            display: none;
        }
        .project-item.expanded .conversations { display: block; }

        .conv-item {
            padding: 8px 10px;
            font-size: 13px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            transition: background 0.1s;
        }
        .conv-item:hover { background: var(--bg-active); }
        .conv-item.active { background: var(--border-muted); }

        .conv-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .conv-menu-btn {
            opacity: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 4px;
            color: var(--text-muted);
            font-size: 14px;
            transition: opacity 0.15s;
        }
        .conv-item:hover .conv-menu-btn { opacity: 1; }
        /* show the same menu button for projects */
        .project-item:hover .conv-menu-btn { opacity: 1; }
        .conv-menu-btn:hover { background: var(--border-muted); }

        .conv-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            box-shadow: 0 4px 16px var(--shadow-lg);
            z-index: 100;
            min-width: 140px;
            overflow: hidden;
        }
        .conv-menu.show { display: block; }

        .conv-menu-item {
            padding: 10px 14px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }
        .conv-menu-item:hover { background: var(--bg-hover); }
        .conv-menu-item.danger { color: #dc2626; }
        .conv-menu-item.danger:hover { background: var(--bg-hover); }

        .conv-rename-input {
            width: 100%;
            padding: 6px 8px;
            font-size: 13px;
            border: 2px solid var(--text-primary);
            border-radius: 4px;
            outline: none;
        }

        /* Main Chat Area */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-chat);
        }

        .chat-header {
            padding: 18px 22px;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-chat);
        }

        .chat-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-heading);
        }

        .header-btn {
            padding: 8px 14px;
            background: var(--bg-header-btn);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s;
        }
        .header-btn:hover { background: var(--bg-active); }
        .header-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Messages */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }

        .message {
            max-width: 820px;
            margin: 0 auto;
            padding: 0 20px;
            margin-bottom: 22px;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(12, 18, 30, 0.04);
        }
        .message.user .message-avatar {
            background: var(--bg-user-avatar);
            color: var(--text-heading);
        }
        .message.assistant .message-avatar {
            background: #ff8a00;
            color: #fff;
        }

        .message-role {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-heading);
        }

        .message-content {
            padding-left: 48px;
            line-height: 1.7;
            font-size: 16px;
            color: var(--text-primary);
        }

        /* Markdown styling */
        .message-content p { margin-bottom: 16px; }
        .message-content p:last-child { margin-bottom: 0; }

        .message-content h1, .message-content h2, .message-content h3 {
            margin-top: 24px;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-heading);
            line-height: 1.4;
        }
        .message-content h1 { font-size: 1.5em; }
        .message-content h2 { font-size: 1.25em; }
        .message-content h3 { font-size: 1.1em; }

        .message-content ul, .message-content ol {
            margin: 16px 0;
            padding-left: 24px;
        }
        .message-content li {
            margin-bottom: 8px;
            line-height: 1.7;
        }

        .message-content code {
            background: var(--bg-code);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'SF Mono', Monaco, Consolas, 'Liberation Mono', monospace;
            font-size: 0.875em;
            color: var(--text-primary);
        }

        .message-content pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 16px 0;
            font-size: 14px;
        }
        .message-content pre code {
            background: none;
            padding: 0;
            color: inherit;
        }

        .message-content strong { font-weight: 600; }
        .message-content em { font-style: italic; }

        .message-content blockquote {
            border-left: 3px solid #d97706;
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-muted);
            font-style: italic;
        }

        .message-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
            font-size: 14px;
        }
        .message-content table th,
        .message-content table td {
            border: 1px solid var(--border-secondary);
            padding: 8px 12px;
            text-align: left;
        }
        .message-content table th {
            background: var(--bg-muted);
            font-weight: 600;
            color: var(--text-heading);
        }
        .message-content table tr:nth-child(even) {
            background: var(--bg-muted);
        }

        .message-content hr {
            border: none;
            border-top: 1px solid var(--border-secondary);
            margin: 24px 0;
        }

        .message-content a {
            color: #d97706;
            text-decoration: none;
        }
        .message-content a:hover {
            text-decoration: underline;
        }

        /* Typing cursor */
        .typing-cursor::after {
            content: '▋';
            animation: blink 1s infinite;
            color: #ff8a00;
            font-size: 14px;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Input Area - Claude style */
        .input-area {
            padding: 8px 20px 12px;
            background: var(--bg-chat);
            border-top: 1px solid var(--border-primary);
        }

        .input-wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Document carousel */
        .doc-carousel-wrapper {
            position: relative;
            margin-bottom: 8px;
            padding: 0 32px;
        }

        .input-doc-chips {
            display: flex;
            gap: 6px;
            overflow-x: auto;
            scroll-behavior: smooth;
            padding: 4px 0;
            -ms-overflow-style: none;
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) transparent;
        }

        .input-doc-chips::-webkit-scrollbar {
            height: 4px;
        }
        .input-doc-chips::-webkit-scrollbar-track {
            background: transparent;
        }
        .input-doc-chips::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 2px;
        }

        .doc-carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: 1px solid var(--border-secondary);
            background: var(--bg-carousel-btn);
            color: var(--text-muted);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            transition: all 0.15s;
            opacity: 0;
            pointer-events: none;
        }
        .doc-carousel-wrapper:hover .doc-carousel-btn.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .doc-carousel-btn:hover {
            background: var(--bg-card);
            border-color: var(--border-muted);
            color: var(--text-secondary);
        }
        .doc-carousel-btn.left { left: 0; }
        .doc-carousel-btn.right { right: 0; }

        .input-doc-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px 8px;
            background: var(--bg-doc-chip);
            border: 1px solid var(--border-primary);
            border-radius: 10px;
            font-size: 12px;
            color: var(--text-heading);
            box-shadow: 0 1px 3px rgba(12,18,30,0.04);
            position: relative;
            transition: box-shadow 0.15s, border-color 0.15s;
            cursor: default;
            min-width: 104px;
            max-width: 104px;
            flex-shrink: 0;
        }

        .input-doc-chip:hover {
            box-shadow: 0 4px 12px rgba(12,18,30,0.08);
            border-color: #e0e4ea;
        }

        .input-doc-chip-icon {
            font-size: 36px;
            margin-bottom: 6px;
            line-height: 1;
        }
        .input-doc-chip-name {
            max-width: 100%;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            text-align: center;
            font-size: 11px;
            line-height: 1.25;
            color: var(--text-secondary);
            word-break: break-word;
            margin-bottom: 2px;
        }
        /* Select checkbox on doc chips (top-right) */
        .doc-select-checkbox {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: #ef4444;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 2;
            margin: 0;
        }

        .input-doc-chip:hover .doc-select-checkbox,
        .input-doc-chip.doc-selected .doc-select-checkbox {
            opacity: 1;
        }

        .input-doc-chip.doc-selected {
            border-color: #ef4444;
        }

        /* Inline batch delete controls (inside filter bar) */
        .batch-actions {
            display: none;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }

        .batch-actions.visible {
            display: flex;
        }

        .batch-actions .batch-count {
            font-size: 12px;
            font-weight: 600;
            color: #ef4444;
            white-space: nowrap;
        }

        .batch-actions .batch-delete-btn {
            padding: 4px 12px;
            background: #ef4444;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.15s;
        }

        .batch-actions .batch-delete-btn:hover {
            background: #dc2626;
        }

        .batch-actions .batch-cancel-btn {
            padding: 4px 8px;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.15s;
        }

        .batch-actions .batch-cancel-btn:hover {
            background: var(--bg-hover);
        }

        /* Select All toggle button in filter bar */
        .doc-select-all-btn {
            padding: 5px 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            background: var(--bg-card);
            color: var(--text-muted);
            transition: all 0.15s;
            font-family: inherit;
            white-space: nowrap;
        }

        .doc-select-all-btn:hover {
            background: var(--bg-muted);
            border-color: var(--border-muted);
        }

        .doc-select-all-btn.active {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        [data-theme="dark"] .doc-select-all-btn.active {
            background: rgba(239,68,68,0.15);
            border-color: #ef4444;
            color: #fca5a5;
        }

        /* Card status display */
        .doc-card-status {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: auto;
            padding-top: 4px;
        }

        .doc-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .doc-status-dot.ready { background: #10b981; }
        .doc-status-dot.processing { background: #3b82f6; animation: pulse-dot 1.5s infinite; }
        .doc-status-dot.queued { background: #f59e0b; }
        .doc-status-dot.error { background: #ef4444; }

        .doc-status-label {
            font-size: 10px;
            color: var(--text-placeholder);
            text-transform: lowercase;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Card action buttons */
        .doc-card-actions {
            position: absolute;
            top: 4px;
            left: 6px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .input-doc-chip:hover .doc-card-actions {
            opacity: 1;
        }

        .doc-card-actions button {
            padding: 2px 5px;
            background: var(--bg-doc-chip-remove);
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text-muted);
            line-height: 1;
            transition: all 0.15s;
        }

        .doc-card-actions button:hover {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        /* Status badges */
        .status-badge {
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        .status-queued { background: #fef3c7; color: #92400e; }
        .status-processing { background: #dbeafe; color: #1e40af; }
        .status-ready { background: #d1fae5; color: #065f46; }
        .status-error { background: #fee2e2; color: #991b1b; }

        .retry-btn {
            padding: 4px 8px;
            background: var(--bg-hover);
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .retry-btn:hover { background: var(--bg-active); }

        .input-container {
            position: relative;
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            background: var(--bg-input-container);
            transition: border-color 0.14s, box-shadow 0.14s;
        }
        .input-container:focus-within {
            border-color: #ff8a00;
            box-shadow: 0 6px 18px rgba(255,138,0,0.06);
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            padding: 8px 14px;
            gap: 10px;
        }

        .attach-btn {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #ff8a00;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            color: #fff;
            font-size: 18px;
            transition: transform 0.12s ease, filter 0.12s;
            flex-shrink: 0;
            box-shadow: 0 6px 18px rgba(255,138,0,0.14);
        }
        .attach-btn:hover { transform: translateY(-1px); filter: brightness(0.98); }

        .input-box {
            flex: 1;
            padding: 8px 0;
            border: none;
            font-size: 15px;
            line-height: 1.6;
            resize: none;
            outline: none;
            font-family: inherit;
            max-height: 200px;
            color: var(--text-primary);
            background: transparent;
        }
        .input-box::placeholder { color: var(--text-placeholder); }

        .send-btn {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--send-btn-bg);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            color: #fff;
            font-size: 16px;
            transition: transform 0.12s ease, opacity 0.12s;
            flex-shrink: 0;
        }
        .send-btn:hover { transform: translateY(-1px); }
        .send-btn:disabled {
            background: var(--send-btn-disabled-bg);
            color: var(--send-btn-disabled-color);
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Hidden file input */
        #fileInput { display: none; }

        /* Upload progress indicator */
        .upload-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 13px;
            color: #92400e;
        }
        .upload-indicator.show { display: flex; }
        .upload-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #fcd34d;
            border-top-color: #d97706;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Full-page drag-and-drop overlay */
        .drop-overlay {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(245,158,11,0.12);
            backdrop-filter: blur(3px);
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        .drop-overlay.visible {
            display: flex;
        }
        .drop-overlay-inner {
            border: 3px dashed #f59e0b;
            border-radius: 20px;
            padding: 48px 64px;
            text-align: center;
        }
        .drop-overlay-inner span {
            font-size: 22px;
            font-weight: 600;
            color: #92400e;
            letter-spacing: 0.3px;
        }

        /* Upload progress (removed — uploads are silent) */

        /* Document search and filter bar */
        .doc-filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .doc-search-input {
            flex: 1;
            min-width: 140px;
            padding: 7px 10px 7px 32px;
            border: 1px solid var(--border-secondary);
            border-radius: 10px;
            font-size: 13px;
            outline: none;
            font-family: inherit;
            transition: border-color 0.15s;
            background: var(--bg-card) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E") 10px center no-repeat;
            color: var(--text-primary);
        }

        .doc-search-input:focus {
            border-color: #f59e0b;
        }

        .doc-search-input::placeholder {
            color: var(--text-placeholder);
        }

        .doc-filter-pills {
            display: flex;
            gap: 4px;
        }

        .doc-filter-pill {
            padding: 5px 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            background: var(--bg-card);
            color: var(--text-muted);
            transition: all 0.15s;
            font-family: inherit;
            white-space: nowrap;
        }

        .doc-filter-pill:hover {
            background: var(--bg-muted);
            border-color: var(--border-muted);
        }

        .doc-filter-pill.active {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal.show { display: flex; }

        .modal-content {
            background: var(--bg-modal);
            padding: 24px;
            border-radius: 16px;
            width: 400px;
            box-shadow: 0 20px 40px var(--shadow-xl);
        }
        .modal-content h3 {
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        .modal-content input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.15s;
            background: var(--bg-input);
            color: var(--text-primary);
        }
        .modal-content input:focus { border-color: #d97706; }

        .modal-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 8px;
        }
        .modal-actions button {
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s;
        }
        .btn-cancel {
            background: var(--bg-header-btn);
            border: 1px solid var(--border-secondary);
            color: var(--text-secondary);
        }
        .btn-cancel:hover { background: var(--bg-active); }
        .btn-create {
            background: #d97706;
            color: #fff;
            border: none;
        }
        .btn-create:hover { background: #b45309; }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 24px;
        }
        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-heading);
        }
        .empty-state p {
            font-size: 15px;
            line-height: 1.6;
        }

        /* Auth Modal */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .auth-modal.active {
            display: flex;
        }

        .auth-modal-content {
            background: var(--bg-modal);
            padding: 40px;
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 20px 60px var(--shadow-xl);
        }

        .auth-modal-content h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-heading);
            margin-bottom: 24px;
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-secondary);
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-size: 14px;
            color: var(--text-muted);
        }

        .auth-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .auth-form button {
            width: 100%;
            padding: 12px;
            background: #ff8a00; /* project orange */
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .auth-form button:hover {
            background: #d97706;
        }

        /* Google-branded button (production-style) */
        .google-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 12px;
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            box-shadow: none;
        }
        .google-btn:hover { background: var(--bg-hover); }
        .google-btn .g-icon { width: 18px; height: 18px; display: inline-block; }
        .google-btn .g-text { color: var(--text-secondary); }

        .auth-error {
            color: #dc2626;
            margin-top: 12px;
            font-size: 13px;
        }

        .auth-success {
            color: #16a34a;
            margin-top: 12px;
            font-size: 13px;
        }

        .auth-link {
            color: #2563eb;
            cursor: pointer;
            font-size: 13px;
            text-decoration: none;
            display: inline-block;
            margin-top: 4px;
            margin-bottom: 8px;
        }
        .auth-link:hover {
            text-decoration: underline;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
            padding: 8px 16px;
            background: var(--bg-header-btn);
            border-radius: 6px;
            font-size: 13px;
        }

        .logout-btn {
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* User menu dropdown */
        .user-menu {
            position: fixed;
            bottom: 16px;
            left: 16px;
            z-index: 1001;
        }

        .user-menu-button {
            padding: 10px 16px;
            min-width: 200px;
            height: 48px;
            border-radius: 10px;
            background: var(--bg-header-btn);
            border: 1px solid var(--border-secondary);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
            transition: all 0.2s;
            box-shadow: 0 2px 8px var(--shadow-md);
        }

        .user-menu-button:hover {
            background: var(--bg-active);
            border-color: var(--border-muted);
            box-shadow: 0 4px 12px var(--shadow-lg);
        }

        .user-menu-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: #ff8a00;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 13px;
            flex-shrink: 0;
        }

        .user-menu-name {
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .user-menu-dropdown {
            display: none;
            position: absolute;
            left: 0;
            bottom: calc(100% + 8px);
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            box-shadow: 0 4px 16px var(--shadow-lg);
            min-width: 240px;
            z-index: 1000;
        }

        .user-menu-dropdown.show {
            display: block;
        }

        .user-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-secondary);
        }

        .user-menu-email {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
            word-break: break-all;
        }

        .user-menu-provider {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .user-menu-items {
            padding: 8px 0;
        }

        .user-menu-item {
            padding: 10px 16px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
        }

        .user-menu-item:hover {
            background: var(--bg-hover);
        }

        .user-menu-item.danger {
            color: #dc2626;
        }

        .user-menu-item.danger:hover {
            background: var(--bg-hover);
        }

        .user-menu-divider {
            height: 1px;
            background: var(--border-secondary);
            margin: 4px 0;
        }

        /* Citation Styles */
        .citation-badge {
            display: inline-block;
            background: #2563eb;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin: 0 2px;
            cursor: pointer;
            vertical-align: super;
            line-height: 1;
        }

        .citation-badge:hover {
            background: #1d4ed8;
        }

        .inline-citation {
            display: inline;
            background: #2563eb;
            color: white;
            padding: 1px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            margin: 0 1px;
            transition: background 0.2s;
        }
        .inline-citation:hover {
            background: #1d4ed8;
        }

        /* Citation Tooltip */
        .citation-tooltip {
            display: none;
            position: fixed;
            max-width: 350px;
            padding: 12px 16px;
            background: #1f2937;
            color: white;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.5;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            pointer-events: none;
        }
        .citation-tooltip.visible {
            display: block;
        }
        .citation-tooltip-header {
            font-weight: 600;
            margin-bottom: 8px;
            color: #93c5fd;
            font-size: 12px;
        }
        .citation-tooltip-content {
            color: #e5e7eb;
        }

        .sources-section {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-sources);
            border-radius: 8px;
            border-left: 3px solid #2563eb;
        }

        .sources-header {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .source-item {
            margin-bottom: 12px;
            padding: 8px;
            background: var(--bg-source-item);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            border: 1px solid var(--border-secondary);
            transition: all 0.2s;
        }

        .source-item:hover {
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }

        .source-item:last-child {
            margin-bottom: 0;
        }

        .source-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .source-number {
            background: #2563eb;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .source-doc-name {
            color: var(--text-secondary);
            font-weight: 500;
            flex: 1;
        }

        .source-score {
            color: var(--text-muted);
            font-size: 11px;
        }

        .source-preview {
            color: var(--text-muted);
            font-size: 12px;
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .source-preview.expanded {
            -webkit-line-clamp: unset;
        }

        /* No Sources Warning */
        .no-sources-warning {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            margin-top: 12px;
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            color: #92400e;
            font-size: 13px;
        }
        .no-sources-warning .warning-icon {
            font-size: 16px;
            flex-shrink: 0;
        }
        .no-sources-warning .warning-text {
            line-height: 1.4;
        }

        /* Faithfulness Badge */
        .faithfulness-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }
        .faithfulness-badge.high {
            background: #d1fae5;
            color: #065f46;
        }
        .faithfulness-badge.medium {
            background: #fef3c7;
            color: #92400e;
        }
        .faithfulness-badge.low {
            background: #fee2e2;
            color: #991b1b;
        }
        .faithfulness-badge .faith-icon {
            font-size: 10px;
        }

        /* Feedback Buttons */
        .feedback-row {
            display: flex;
            align-items: center;
            gap: 6px;
            padding-left: 48px;
            margin-top: 6px;
            opacity: 0.45;
            transition: opacity 0.2s;
        }
        .message:hover .feedback-row,
        .feedback-row.has-feedback {
            opacity: 1;
        }
        .feedback-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            background: var(--bg-card);
            cursor: pointer;
            font-size: 14px;
            color: var(--text-muted);
            transition: all 0.15s;
            padding: 0;
            line-height: 1;
        }
        .feedback-btn:hover {
            background: var(--bg-hover);
            border-color: var(--border-muted);
        }
        .feedback-btn.selected {
            border-color: transparent;
        }
        .feedback-btn.selected.positive {
            background: #d1fae5;
            color: #065f46;
        }
        .feedback-btn.selected.negative {
            background: #fee2e2;
            color: #991b1b;
        }
        .feedback-btn.dimmed {
            opacity: 0.35;
            cursor: default;
        }
        .feedback-comment-area {
            display: none;
            padding-left: 48px;
            margin-top: 6px;
        }
        .feedback-comment-area.visible {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .feedback-comment-input {
            flex: 1;
            max-width: 350px;
            padding: 6px 10px;
            border: 1px solid var(--border-secondary);
            border-radius: 6px;
            font-size: 12px;
            outline: none;
            font-family: inherit;
            background: var(--bg-input);
            color: var(--text-primary);
        }
        .feedback-comment-input:focus {
            border-color: #ff8a00;
        }
        .feedback-comment-submit {
            padding: 6px 12px;
            background: var(--send-btn-bg);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            font-weight: 500;
        }
        .feedback-comment-submit:hover {
            background: #1f2937;
        }
        .feedback-thanks {
            font-size: 12px;
            color: var(--text-muted);
            padding-left: 4px;
        }

        /* Citation Modal */
        .citation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .citation-modal.active {
            display: flex;
        }

        .citation-modal-content {
            background: var(--bg-modal);
            padding: 24px;
            border-radius: 12px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px var(--shadow-xl);
        }

        .citation-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .citation-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-heading);
        }

        .citation-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .citation-modal-close:hover {
            background: var(--bg-hover);
        }

        .citation-full-text {
            background: var(--bg-citation-full);
            padding: 16px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .citation-meta {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-secondary);
            font-size: 13px;
            color: var(--text-muted);
        }

        .citation-meta-item {
            margin-bottom: 8px;
        }

        .citation-meta-label {
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* ========== Source Preview Side Panel ========== */
        .source-panel-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.15);
            z-index: 5000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .source-panel-overlay.active {
            display: block;
            opacity: 1;
        }

        .source-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 420px;
            height: 100vh;
            background: var(--bg-card);
            box-shadow: -4px 0 24px var(--shadow-lg);
            z-index: 5001;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .source-panel.open {
            transform: translateX(0);
        }

        .source-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-sidebar);
            flex-shrink: 0;
        }

        .source-panel-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-heading);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            margin-right: 12px;
        }

        .source-panel-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 18px;
            transition: all 0.15s;
            flex-shrink: 0;
        }
        .source-panel-close:hover {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        .source-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* Document info section */
        .source-panel-doc-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 14px 16px;
            background: var(--bg-muted);
            border-radius: 10px;
            margin-bottom: 16px;
        }

        .source-panel-doc-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .source-panel-doc-label {
            color: var(--text-muted);
            min-width: 70px;
            font-weight: 500;
        }

        .source-panel-doc-value {
            color: var(--text-heading);
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Relevance score bar */
        .source-panel-score {
            margin-bottom: 20px;
        }

        .source-panel-score-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 6px;
        }

        .source-panel-score-value {
            font-weight: 700;
        }

        .source-panel-score-bar {
            width: 100%;
            height: 8px;
            background: var(--border-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .source-panel-score-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.4s ease, background 0.3s;
        }

        .score-high { background: #22c55e; }
        .score-medium { background: #f59e0b; }
        .score-low { background: #ef4444; }

        /* Chunk text content */
        .source-panel-content-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .source-panel-chunk-text {
            background: var(--bg-muted);
            border: 1px solid var(--border-primary);
            padding: 16px;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .source-panel-chunk-text mark {
            background: #fef08a;
            color: #0b1220;  /* keep readable on yellow */
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* Panel navigation */
        .source-panel-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-top: 1px solid var(--border-primary);
            background: var(--bg-sidebar);
            flex-shrink: 0;
        }

        .source-panel-nav-btn {
            padding: 8px 16px;
            background: var(--bg-header-btn);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .source-panel-nav-btn:hover:not(:disabled) {
            background: var(--bg-active);
        }
        .source-panel-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .source-panel-nav-indicator {
            font-size: 13px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .source-panel-open-doc {
            display: block;
            width: 100%;
            margin-top: 16px;
            padding: 10px 16px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            transition: background 0.15s;
        }
        .source-panel-open-doc:hover {
            background: #1d4ed8;
        }

        /* Responsive: hide panel on mobile, use modal fallback */
        @media (max-width: 768px) {
            .source-panel {
                display: none !important;
            }
            .source-panel-overlay {
                display: none !important;
            }
        }

        /* ========== Analytics Dashboard Styles ========== */
        .analytics-nav-btn {
            position: fixed;
            bottom: 72px;
            left: 16px;
            width: 200px;
            padding: 10px 16px;
            background: var(--bg-header-btn);
            color: var(--text-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: background 0.12s;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 999;
            box-shadow: 0 2px 8px var(--shadow-md);
        }
        .analytics-nav-btn:hover { background: var(--bg-active); border-color: var(--border-muted); }
        .analytics-nav-btn.active { background: #ff8a00; color: #fff; border-color: #ff8a00; }
        .analytics-nav-btn svg { width: 16px; height: 16px; flex-shrink: 0; }

        .bult-badge {
            position: fixed;
            bottom: 128px;
            left: 0;
            width: 240px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            color: var(--text-muted);
            font-size: 12px;
            text-decoration: none;
            border-radius: 8px;
            transition: background 0.15s, color 0.15s;
        }
        .bult-badge:hover { background: var(--bg-hover); color: var(--text-secondary); }
        .bult-badge img { height: 16px; width: auto; }
        [data-theme="dark"] .bult-badge img { filter: invert(1) brightness(2); }

        .analytics-view {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100vh;
            background: var(--bg-analytics);
            overflow-y: auto;
            min-width: 0;
        }
        .analytics-view.active { display: flex; }
        .main.hidden-for-analytics { display: none !important; }

        .analytics-header {
            padding: 18px 22px;
            border-bottom: 1px solid var(--border-primary);
            background: var(--bg-chat);
            flex-shrink: 0;
        }
        .analytics-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-heading);
            margin: 0;
        }
        .analytics-header p {
            font-size: 13px;
            color: var(--text-muted);
            margin: 4px 0 0;
        }

        .analytics-content {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .analytics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .analytics-card {
            background: var(--bg-analytics-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .analytics-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }

        .analytics-card-icon {
            width: 36px; height: 36px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: 700;
        }
        .analytics-card-icon.docs { background: #dbeafe; color: #2563eb; }
        .analytics-card-icon.queries { background: #fef3c7; color: #d97706; }
        .analytics-card-icon.latency { background: #d1fae5; color: #059669; }
        .analytics-card-icon.convs { background: #ede9fe; color: #7c3aed; }
        .analytics-card-icon.chunks { background: #fce7f3; color: #db2777; }

        .analytics-card-value { font-size: 28px; font-weight: 700; color: var(--text-heading); line-height: 1; }
        .analytics-card-label { font-size: 13px; color: var(--text-muted); font-weight: 500; }

        .analytics-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        .analytics-chart-box {
            background: var(--bg-analytics-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px;
        }
        .analytics-chart-box h4 { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin: 0 0 16px; }
        .analytics-chart-box canvas { max-height: 280px; }

        .analytics-table-box {
            background: var(--bg-analytics-card); border: 1px solid var(--border-primary); border-radius: 12px; padding: 20px; margin-bottom: 24px;
        }
        .analytics-table-box h4 { font-size: 14px; font-weight: 600; color: var(--text-secondary); margin: 0 0 12px; }

        .analytics-table { width: 100%; border-collapse: collapse; }
        .analytics-table th, .analytics-table td {
            padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border-primary); font-size: 13px;
        }
        .analytics-table th { font-weight: 600; color: var(--text-secondary); background: var(--bg-table-th); }
        .analytics-table td { color: var(--text-muted); }
        .analytics-table tr:last-child td { border-bottom: none; }

        .analytics-processing {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;
        }
        .processing-stat { text-align: center; padding: 16px; border-radius: 8px; background: var(--bg-processing-stat); }
        .processing-stat-value { font-size: 24px; font-weight: 700; }
        .processing-stat-label { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .processing-stat.completed .processing-stat-value { color: #059669; }
        .processing-stat.failed .processing-stat-value { color: #dc2626; }
        .processing-stat.processing .processing-stat-value { color: #2563eb; }
        .processing-stat.queued .processing-stat-value { color: #d97706; }

        .analytics-loading {
            display: flex; align-items: center; justify-content: center;
            padding: 60px; color: var(--text-muted); font-size: 15px;
        }
        .analytics-empty {
            text-align: center; padding: 60px 24px; color: var(--text-muted);
        }
        .analytics-empty h3 { font-size: 18px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }

        @media (max-width: 768px) {
            .analytics-cards { grid-template-columns: 1fr 1fr; }
            .analytics-charts { grid-template-columns: 1fr; }
        }
        @media (max-width: 480px) {
            .analytics-cards { grid-template-columns: 1fr; }
        }

        /* ========== Onboarding Overlay ========== */
        .onboarding-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 11000;
            align-items: center;
            justify-content: center;
        }
        .onboarding-overlay.active {
            display: flex;
        }

        .onboarding-card {
            background: var(--bg-modal);
            border-radius: 16px;
            padding: 40px 36px 32px;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.2);
            text-align: center;
            animation: onboardingFadeIn 0.3s ease;
        }

        @keyframes onboardingFadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .onboarding-card h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-heading);
            margin-bottom: 8px;
        }

        .onboarding-card .onboarding-desc {
            font-size: 15px;
            color: var(--text-muted);
            line-height: 1.6;
            margin-bottom: 28px;
        }

        .onboarding-steps {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 32px;
        }

        .onboarding-step {
            flex: 1;
            max-width: 140px;
            padding: 20px 12px 16px;
            background: var(--bg-muted);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            text-align: center;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .onboarding-step:hover {
            border-color: #fcd34d;
            box-shadow: 0 4px 12px rgba(255, 138, 0, 0.08);
        }

        .onboarding-step-icon {
            font-size: 32px;
            margin-bottom: 10px;
            line-height: 1;
        }

        .onboarding-step-num {
            display: inline-block;
            width: 22px;
            height: 22px;
            line-height: 22px;
            border-radius: 50%;
            background: #ff8a00;
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .onboarding-step-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-heading);
            line-height: 1.3;
        }

        .onboarding-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .onboarding-btn-start {
            padding: 12px 32px;
            background: #ff8a00;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s, transform 0.12s;
        }
        .onboarding-btn-start:hover {
            background: #d97706;
            transform: translateY(-1px);
        }

        .onboarding-btn-skip {
            background: none;
            border: none;
            color: var(--text-placeholder);
            font-size: 13px;
            cursor: pointer;
            padding: 4px 8px;
            transition: color 0.15s;
        }
        .onboarding-btn-skip:hover {
            color: var(--text-muted);
        }

        /* ========== Onboarding Tooltips ========== */
        .onboarding-tooltip {
            position: absolute;
            background: #1f2937;
            color: #fff;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 10500;
            pointer-events: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            animation: tooltipFadeIn 0.25s ease;
        }

        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .onboarding-tooltip::after {
            content: '';
            position: absolute;
            border: 6px solid transparent;
        }

        .onboarding-tooltip.arrow-bottom::after {
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-top-color: #1f2937;
        }

        .onboarding-tooltip.arrow-top::after {
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-bottom-color: #1f2937;
        }

        .onboarding-tooltip.arrow-left::after {
            top: 50%;
            right: 100%;
            transform: translateY(-50%);
            border-right-color: #1f2937;
        }

        @media (max-width: 480px) {
            .onboarding-steps {
                flex-direction: column;
                align-items: center;
            }
            .onboarding-step {
                max-width: 240px;
                width: 100%;
            }
        }

        /* ========== Theme Toggle Button ========== */
        .theme-toggle-icon {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-header-btn);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s ease;
            padding: 0;
            flex-shrink: 0;
        }
        .theme-toggle-icon:hover {
            background: var(--bg-active);
            color: var(--text-secondary);
        }
        .theme-toggle-icon svg {
            width: 16px;
            height: 16px;
        }
        .theme-toggle-icon .icon-sun { display: none; }
        .theme-toggle-icon .icon-moon { display: block; }
        [data-theme="dark"] .theme-toggle-icon .icon-sun { display: block; }
        [data-theme="dark"] .theme-toggle-icon .icon-moon { display: none; }

        body, .sidebar, .main, .chat-header, .input-area, .input-container,
        .modal-content, .auth-modal-content, .source-panel, .source-panel-header,
        .source-panel-nav, .analytics-view, .analytics-header, .analytics-card,
        .analytics-chart-box, .analytics-table-box, .user-menu-button,
        .user-menu-dropdown, .feedback-btn, .header-btn, .conv-menu,
        .citation-modal-content {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }

        [data-theme="dark"] #modelSelector {
            background: var(--bg-header-btn) !important;
            color: var(--text-secondary) !important;
            border-color: var(--border-secondary) !important;
        }

        /* ========== Export Dropdown ========== */
        .export-dropdown-wrapper {
            position: relative;
            display: inline-block;
        }
        .export-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border-secondary);
            border-radius: 8px;
            box-shadow: 0 4px 16px var(--shadow-lg);
            z-index: 100;
            min-width: 140px;
            overflow: hidden;
        }
        .export-dropdown.show { display: block; }
        .export-dropdown-item {
            padding: 10px 14px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
        }
        .export-dropdown-item:hover { background: var(--bg-hover); }

    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>RAG Chat</h2>
            <button class="new-btn" onclick="showNewProjectModal()">+ New Project</button>
        </div>
        <div class="projects-list" id="projectsList"></div>
        <button class="analytics-nav-btn" id="analyticsNavBtn" onclick="toggleAnalyticsView()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>
            Analytics
        </button>
        <a href="https://bult.ai" target="_blank" rel="noopener" class="bult-badge">
            Made with <img src="/static/bult-logo.png" alt="bult.ai">
        </a>
    </div>

    <!-- Analytics View (hidden by default) -->
    <div class="analytics-view" id="analyticsView">
        <div class="analytics-header">
            <h3>Analytics Dashboard</h3>
            <p>Overview of your RAG system usage and performance</p>
        </div>
        <div class="analytics-content" id="analyticsContent">
            <div class="analytics-loading" id="analyticsLoading">Loading analytics...</div>
        </div>
    </div>

    <!-- Main -->
    <div class="main" id="mainView">
        <div class="chat-header">
            <div style="display: flex; align-items: center; gap: 24px; flex: 1;">
                <h3 id="chatTitle">Select a project</h3>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <select id="modelSelector" onchange="switchModel()" style="padding:6px 10px;border:1px solid var(--border-secondary);border-radius:6px;font-size:13px;background:var(--bg-card);color:var(--text-secondary);cursor:pointer;display:none;">
                </select>
                <div class="export-dropdown-wrapper" id="exportDropdownWrapper" style="display:none;">
                    <button class="header-btn" onclick="toggleExportDropdown(event)" title="Export conversation">Export</button>
                    <div class="export-dropdown" id="exportDropdown">
                        <div class="export-dropdown-item" onclick="exportConversation('md')">Markdown (.md)</div>
                        <div class="export-dropdown-item" onclick="exportConversation('pdf')">PDF (.pdf)</div>
                        <div class="export-dropdown-item" onclick="exportConversation('json')">JSON (.json)</div>
                    </div>
                </div>
                <button class="header-btn" onclick="newConversation()" id="newConvBtn" disabled>New Chat</button>
                <button class="theme-toggle-icon" id="themeToggleBtn" onclick="toggleTheme()" title="Toggle dark mode (Alt+D)" aria-label="Toggle dark mode">
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                </button>
            </div>
        </div>

        <div class="messages" id="messages">
            <div class="empty-state">
                <h3>Welcome to RAG Chat</h3>
                <p>Create or select a project to get started</p>
            </div>
        </div>

        <div class="input-area" id="inputArea" style="display:none">
            <div class="input-wrapper">
                <!-- Upload indicator (legacy spinner) -->
                <div class="upload-indicator" id="uploadIndicator">
                    <div class="upload-spinner"></div>
                    <span>Processing document...</span>
                </div>

                <!-- Document search bar -->
                <div class="doc-filter-bar" id="docFilterBar" style="display:none">
                    <input type="text" class="doc-search-input" id="docSearchInput" placeholder="Search documents..." oninput="onDocSearchInput()">
                    <button class="doc-select-all-btn" id="docSelectAllBtn" onclick="toggleSelectAllDocs()" title="Select documents for batch actions">Select All</button>
                    <div class="batch-actions" id="batchActions">
                        <span class="batch-count" id="batchCount">0 selected</span>
                        <button class="batch-delete-btn" onclick="batchDeleteSelected()">Delete</button>
                        <button class="batch-cancel-btn" onclick="clearDocSelection()">Cancel</button>
                    </div>
                </div>

                <!-- Document carousel -->
                <div class="doc-carousel-wrapper" id="docCarouselWrapper" style="display:none">
                    <button class="doc-carousel-btn left" id="docCarouselLeft" onclick="scrollDocCarousel(-1)">&#8249;</button>
                    <div class="input-doc-chips" id="docChips"></div>
                    <button class="doc-carousel-btn right" id="docCarouselRight" onclick="scrollDocCarousel(1)">&#8250;</button>
                </div>

                <!-- Input container -->
                <div class="input-container">
                    <div class="input-row">
                        <button class="attach-btn" onclick="document.getElementById('fileInput').click()" title="Attach files">+</button>
                        <textarea class="input-box" id="messageInput" placeholder="Reply..." rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)" disabled></textarea>
                        <button class="send-btn" onclick="sendMessage()" id="sendBtn" disabled>↑</button>
                    </div>
                </div>
                <input type="file" id="fileInput" multiple onchange="uploadFiles()" accept=".pdf,.docx,.doc,.pptx,.ppt,.txt,.md,.csv,.json,.html,.htm,.py,.js,.ts,.jsx,.tsx,.java,.c,.cpp,.h,.go,.rs,.rb,.php,.css,.xml,.yaml,.yml">
            </div>
        </div>
    </div>

    <!-- Full-page drop overlay -->
    <div class="drop-overlay" id="dropOverlay">
        <div class="drop-overlay-inner">
            <span>Drop your files here</span>
        </div>
    </div>

    <!-- New Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <h3>New Project</h3>
            <input type="text" id="projectName" placeholder="Project name">
            <input type="text" id="projectDesc" placeholder="Description (optional)">
            <div class="modal-actions">
                <button class="btn-cancel" onclick="hideModal()">Cancel</button>
                <button class="btn-create" onclick="createProject()">Create</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="auth-modal">
        <div class="auth-modal-content">
            <h2>Welcome to RAG System</h2>

            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="register">Register</button>
            </div>

            <div id="loginForm" class="auth-form">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button onclick="handleLogin()">Login</button>
                <div style="text-align: center; margin-top: 8px;">
                    <a class="auth-link" onclick="showForgotPassword()">Forgot password?</a>
                </div>
            </div>

            <div id="forgotPasswordForm" class="auth-form" style="display: none;">
                <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5;">
                    Enter your email address and we'll send you a link to reset your password.
                </p>
                <input type="email" id="forgotEmail" placeholder="Email" required>
                <button onclick="handleForgotPassword()">Send Reset Link</button>
                <div style="text-align: center; margin-top: 8px;">
                    <a class="auth-link" onclick="showLoginFromForgot()">Back to login</a>
                </div>
                <div id="forgotPasswordSuccess" class="auth-success" style="display: none;"></div>
                <div id="forgotPasswordError" class="auth-error" style="display: none;"></div>
            </div>

            <div id="registerForm" class="auth-form" style="display: none;">
                <input type="email" id="registerEmail" placeholder="Email" required>
                <input type="password" id="registerPassword" placeholder="Password" required>
                <input type="password" id="registerConfirm" placeholder="Confirm Password" required>
                <button onclick="handleRegister()">Create Account</button>
            </div>

            <div id="authError" class="auth-error"></div>

            <div style="margin-top:12px;text-align:center;">
                <button class="google-btn" onclick="window.location.href='/api/auth/google/login'" aria-label="Sign in with Google">
                    <span class="g-icon" aria-hidden="true">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="18" height="18">
                            <path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C34.7 32.9 30 36 24 36c-7.7 0-14-6.3-14-14s6.3-14 14-14c3.5 0 6.7 1.3 9.1 3.5l6.4-6.4C36.6 2.8 30.6 0 24 0 10.7 0 0 10.7 0 24s10.7 24 24 24c12.2 0 22.3-8.7 23.9-20H43.6z"/>
                            <path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.4 16.3 18.9 13.6 24 13.6c3.5 0 6.7 1.3 9.1 3.5l6.4-6.4C36.6 2.8 30.6 0 24 0 15.3 0 7.9 5.6 6.3 14.7z"/>
                            <path fill="#4CAF50" d="M24 48c6.6 0 12.6-2.4 17.1-6.6L34.6 36.9C32.2 38.9 28.9 40 24 40c-6 0-10.7-3.1-13-7.6l-6.7 5.1C7.9 42.4 15.3 48 24 48z"/>
                            <path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1 2.9-3 5.3-5.6 6.9l8.9 6.8C42.9 36.8 48 29.9 48 24c0-1.6-.1-3.1-.4-4.5z"/>
                        </svg>
                    </span>
                    <span class="g-text">Sign in with Google</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="auth-modal">
        <div class="auth-modal-content">
            <h2>Change Password</h2>
            <div class="auth-form">
                <input type="password" id="currentPassword" placeholder="Current Password" required>
                <input type="password" id="newPassword" placeholder="New Password (min 8 characters)" required>
                <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" required>
                <button onclick="handleChangePassword()">Update Password</button>
                <button onclick="hideChangePasswordModal()" style="background: #6b7280; margin-top: 8px;">Cancel</button>
            </div>
            <div id="changePasswordError" class="auth-error"></div>
        </div>
    </div>

    <!-- Reset Password Modal (shown when URL has ?reset_token=...) -->
    <div id="resetPasswordModal" class="auth-modal">
        <div class="auth-modal-content">
            <h2>Set New Password</h2>
            <div id="resetPasswordFormContainer" class="auth-form">
                <input type="password" id="resetNewPassword" placeholder="New Password (min 8 characters)" required>
                <input type="password" id="resetConfirmPassword" placeholder="Confirm New Password" required>
                <button onclick="handleResetPassword()">Reset Password</button>
            </div>
            <div id="resetPasswordSuccess" class="auth-success" style="display: none;"></div>
            <div id="resetPasswordError" class="auth-error"></div>
        </div>
    </div>

    <!-- Citation Modal -->
    <div id="citationModal" class="citation-modal">
        <div class="citation-modal-content">
            <div class="citation-modal-header">
                <h3 class="citation-modal-title">Source Citation</h3>
                <button class="citation-modal-close" onclick="closeCitationModal()">&times;</button>
            </div>
            <div id="citationModalBody"></div>
        </div>
    </div>

    <!-- Citation Tooltip -->
    <div id="citationTooltip" class="citation-tooltip"></div>

    <!-- Source Preview Side Panel -->
    <div id="sourcePanelOverlay" class="source-panel-overlay" onclick="closeSourcePanel()"></div>
    <div id="sourcePanel" class="source-panel">
        <div class="source-panel-header">
            <div class="source-panel-title" id="sourcePanelTitle">Source Citation</div>
            <button class="source-panel-close" onclick="closeSourcePanel()" title="Close panel">&times;</button>
        </div>
        <div class="source-panel-body" id="sourcePanelBody">
            <!-- Populated dynamically -->
        </div>
        <div class="source-panel-nav" id="sourcePanelNav" style="display:none;">
            <button class="source-panel-nav-btn" id="sourcePanelPrev" onclick="navigateSourcePanel(-1)" disabled>
                &#8592; Previous
            </button>
            <span class="source-panel-nav-indicator" id="sourcePanelIndicator">1 of 1</span>
            <button class="source-panel-nav-btn" id="sourcePanelNext" onclick="navigateSourcePanel(1)" disabled>
                Next &#8594;
            </button>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div id="onboardingOverlay" class="onboarding-overlay" onclick="if(event.target===this){completeOnboarding(false)}">
        <div class="onboarding-card">
            <h2>Welcome to RAG Chat</h2>
            <p class="onboarding-desc">Upload documents and ask questions. Get accurate answers with citations.</p>
            <div class="onboarding-steps">
                <div class="onboarding-step">
                    <div class="onboarding-step-icon">&#128193;</div>
                    <div class="onboarding-step-num">1</div>
                    <div class="onboarding-step-label">Create a project</div>
                </div>
                <div class="onboarding-step">
                    <div class="onboarding-step-icon">&#128196;</div>
                    <div class="onboarding-step-num">2</div>
                    <div class="onboarding-step-label">Upload documents</div>
                </div>
                <div class="onboarding-step">
                    <div class="onboarding-step-icon">&#128172;</div>
                    <div class="onboarding-step-num">3</div>
                    <div class="onboarding-step-label">Ask questions</div>
                </div>
            </div>
            <div class="onboarding-actions">
                <button class="onboarding-btn-start" onclick="completeOnboarding(true)">Get Started</button>
                <button class="onboarding-btn-skip" onclick="completeOnboarding(false)">Skip</button>
            </div>
        </div>
    </div>


    <script>
        // ========== Theme Management ==========

        function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved) {
                document.documentElement.setAttribute('data-theme', saved);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            // Auto-follow OS theme when user has no saved preference
            try {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('theme')) {
                        document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                    }
                });
            } catch (_) { /* older browsers */ }
            // Update button label when DOM is ready
            const appliedTheme = document.documentElement.getAttribute('data-theme') || 'light';
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => updateThemeLabel(appliedTheme));
            } else {
                updateThemeLabel(appliedTheme);
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeLabel(next);
        }

        function updateThemeLabel(theme) {
            const label = document.getElementById('themeLabel');
            if (label) label.textContent = theme === 'dark' ? 'Light mode' : 'Dark mode';
        }

        // Apply theme immediately to prevent flash of wrong theme
        initTheme();

        // ========== Authentication ==========

        let authToken = localStorage.getItem('authToken');
        let currentUser = null;

        // Check authentication on page load
        async function checkAuth() {
            // Try cookie-based session first (OAuth will set HttpOnly cookie)
            try {
                const resCookie = await fetch('/api/auth/me');
                if (resCookie.ok) {
                    currentUser = await resCookie.json();
                    authToken = null;
                    localStorage.removeItem('authToken');
                    hideAuthModal();
                    updateUserInfo();
                    await loadProjects();
                    return true;
                }
            } catch (e) {
                // ignore and fall back to token
            }

            // Fallback: token in localStorage (legacy)
            if (!authToken) {
                showAuthModal();
                return false;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (!response.ok) {
                    // Token invalid or expired
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showAuthModal();
                    return false;
                }

                currentUser = await response.json();
                hideAuthModal();
                updateUserInfo();
                await loadProjects();
                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                showAuthModal();
                return false;
            }
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function updateUserInfo() {
            if (currentUser) {
                // Get initials from email (first 2 characters)
                const initials = currentUser.email.slice(0, 2).toUpperCase();

                // Get username from email (part before @)
                const username = currentUser.email.split('@')[0];

                // Determine provider display
                const providerText = currentUser.oauth_provider === 'google'
                    ? 'Signed in with Google'
                    : 'Email account';

                // Show "Change Password" only for password-based accounts
                const changePasswordItem = currentUser.oauth_provider === 'google'
                    ? ''
                    : '<div class="user-menu-item" onclick="showChangePasswordModal()">Change Password</div>';

                const userMenuHTML = `
                    <div class="user-menu" id="userMenu">
                        <button class="user-menu-button" onclick="toggleUserMenu(event)" aria-label="User menu">
                            <div class="user-menu-avatar">${initials}</div>
                            <div class="user-menu-name">${escapeHtml(username)}</div>
                        </button>
                        <div class="user-menu-dropdown" id="userMenuDropdown">
                            <div class="user-menu-header">
                                <div class="user-menu-email">${escapeHtml(currentUser.email)}</div>
                                <div class="user-menu-provider">${providerText}</div>
                            </div>
                            <div class="user-menu-items">
                                ${changePasswordItem}
                                <div class="user-menu-divider"></div>
                                <div class="user-menu-item danger" onclick="handleLogout()">Logout</div>
                            </div>
                        </div>
                    </div>
                `;

                // Add to body (not header) since it's fixed positioned
                const body = document.querySelector('body');
                if (body && !document.getElementById('userMenu')) {
                    body.insertAdjacentHTML('beforeend', userMenuHTML);
                }
            }
        }

        function toggleUserMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userMenuDropdown');
            dropdown.classList.toggle('show');
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            const userMenu = document.getElementById('userMenu');
            if (userMenu && !userMenu.contains(e.target)) {
                const dropdown = document.getElementById('userMenuDropdown');
                if (dropdown) {
                    dropdown.classList.remove('show');
                }
            }
        });

        function showChangePasswordModal() {
            // Close user menu
            const dropdown = document.getElementById('userMenuDropdown');
            if (dropdown) dropdown.classList.remove('show');

            // Show change password modal
            document.getElementById('changePasswordModal').classList.add('active');
            document.body.style.overflow = 'hidden';

            // Clear fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('changePasswordError').textContent = '';
        }

        function hideChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        async function handleChangePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            const errorDiv = document.getElementById('changePasswordError');

            errorDiv.textContent = '';

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                errorDiv.textContent = 'All fields are required';
                return;
            }

            if (newPassword.length < 8) {
                errorDiv.textContent = 'New password must be at least 8 characters';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: Object.assign({'Content-Type': 'application/json'}, authToken ? {'Authorization': `Bearer ${authToken}`} : {}),
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to change password');
                }

                // Success
                hideChangePasswordModal();
                alert('Password changed successfully!');

            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('authError');

            errorDiv.textContent = '';

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Login failed');
                }

                const data = await response.json();
                authToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);

                hideAuthModal();
                updateUserInfo();

                // Reload projects and conversations
                loadProjects();
                initOnboarding();

            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }

        async function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerConfirm').value;
            const errorDiv = document.getElementById('authError');

            errorDiv.textContent = '';

            if (password !== confirm) {
                errorDiv.textContent = 'Passwords do not match';
                return;
            }

            if (password.length < 8) {
                errorDiv.textContent = 'Password must be at least 8 characters';
                return;
            }

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Registration failed');
                }

                const data = await response.json();
                authToken = data.access_token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);

                hideAuthModal();
                updateUserInfo();

                // Load initial data
                loadProjects();
                initOnboarding();

            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }

        async function handleLogout() {
            try {
                // Call backend logout to clear cookie
                await fetch('/api/auth/logout', { method: 'POST' });
            } catch (e) {
                console.error('Logout error:', e);
            }
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            location.reload();
        }

        // ========== Forgot / Reset Password ==========

        function showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
            document.getElementById('forgotPasswordSuccess').style.display = 'none';
            document.getElementById('forgotPasswordError').style.display = 'none';
            document.getElementById('authError').textContent = '';
            // Hide tabs
            document.querySelector('.auth-tabs').style.display = 'none';
        }

        function showLoginFromForgot() {
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            // Restore tabs
            document.querySelector('.auth-tabs').style.display = 'flex';
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.auth-tab[data-tab="login"]').classList.add('active');
        }

        async function handleForgotPassword() {
            const email = document.getElementById('forgotEmail').value.trim();
            const successDiv = document.getElementById('forgotPasswordSuccess');
            const errorDiv = document.getElementById('forgotPasswordError');
            successDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            if (!email) {
                errorDiv.textContent = 'Please enter your email address';
                errorDiv.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/api/auth/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const data = await response.json();
                successDiv.textContent = data.message || 'If an account exists with that email, a reset link has been sent.';
                successDiv.style.display = 'block';
            } catch (error) {
                errorDiv.textContent = 'Something went wrong. Please try again.';
                errorDiv.style.display = 'block';
            }
        }

        async function handleResetPassword() {
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;
            const errorDiv = document.getElementById('resetPasswordError');
            const successDiv = document.getElementById('resetPasswordSuccess');
            errorDiv.textContent = '';
            successDiv.style.display = 'none';

            if (newPassword.length < 8) {
                errorDiv.textContent = 'Password must be at least 8 characters';
                return;
            }

            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                return;
            }

            // Get token from URL
            const params = new URLSearchParams(window.location.search);
            const token = params.get('reset_token');

            if (!token) {
                errorDiv.textContent = 'Invalid reset link';
                return;
            }

            try {
                const response = await fetch('/api/auth/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, new_password: newPassword })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.detail || 'Failed to reset password');
                }

                // Hide the form and show success
                document.getElementById('resetPasswordFormContainer').style.display = 'none';
                successDiv.textContent = 'Password has been reset successfully! Redirecting to login...';
                successDiv.style.display = 'block';

                // Clean URL and redirect to login after a short delay
                setTimeout(() => {
                    window.history.replaceState({}, document.title, '/');
                    document.getElementById('resetPasswordModal').classList.remove('active');
                    showAuthModal();
                }, 2000);
            } catch (error) {
                errorDiv.textContent = error.message;
            }
        }

        function checkResetToken() {
            const params = new URLSearchParams(window.location.search);
            const resetToken = params.get('reset_token');
            if (resetToken) {
                // Show reset password modal instead of auth modal
                document.getElementById('authModal').classList.remove('active');
                document.getElementById('resetPasswordModal').classList.add('active');
                document.body.style.overflow = 'hidden';
                return true;
            }
            return false;
        }

        // Tab switching
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;

                    // Update active tab
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Show/hide forms
                    document.getElementById('loginForm').style.display = tabName === 'login' ? 'block' : 'none';
                    document.getElementById('registerForm').style.display = tabName === 'register' ? 'block' : 'none';
                    document.getElementById('forgotPasswordForm').style.display = 'none';

                    // Clear error
                    document.getElementById('authError').textContent = '';

                    // Restore tabs visibility
                    document.querySelector('.auth-tabs').style.display = 'flex';
                });
            });

            // Check for reset token in URL first
            if (!checkResetToken()) {
                // Check auth on page load, then show onboarding if first visit
                checkAuth().then(authed => {
                    if (authed) initOnboarding();
                });
            }
        });

        // ========== Onboarding ==========

        function initOnboarding() {
            if (!localStorage.getItem('onboarded')) {
                document.getElementById('onboardingOverlay').classList.add('active');
            }
        }

        function completeOnboarding(openProject) {
            localStorage.setItem('onboarded', 'true');
            document.getElementById('onboardingOverlay').classList.remove('active');

            if (openProject) {
                // Small delay so overlay animation completes before modal opens
                setTimeout(() => {
                    showNewProjectModal();
                }, 200);
            }

            // Show tooltip hints after overlay closes (only once each)
            setTimeout(() => {
                showOnboardingTooltip('newProjectBtn', 'Start here \u2014 create your first project', 'right');
            }, 600);
        }

        function showOnboardingTooltip(elementKey, text, direction) {
            const storageKey = 'tooltip_shown_' + elementKey;
            if (localStorage.getItem(storageKey)) return;

            let targetEl = null;
            if (elementKey === 'newProjectBtn') {
                // The "+ New Project" button inside the sidebar header
                targetEl = document.querySelector('.sidebar-header .new-btn');
            } else if (elementKey === 'attachBtn') {
                // The attach button in the input area
                targetEl = document.querySelector('.attach-btn');
            }

            if (!targetEl) return;

            localStorage.setItem(storageKey, 'true');

            const tooltip = document.createElement('div');
            tooltip.className = 'onboarding-tooltip';
            tooltip.textContent = text;
            document.body.appendChild(tooltip);

            // Position tooltip relative to the target element
            const rect = targetEl.getBoundingClientRect();

            if (direction === 'right') {
                tooltip.classList.add('arrow-left');
                tooltip.style.top = (rect.top + rect.height / 2 - tooltip.offsetHeight / 2) + 'px';
                tooltip.style.left = (rect.right + 12) + 'px';
            } else if (direction === 'top') {
                tooltip.classList.add('arrow-bottom');
                tooltip.style.top = (rect.top - tooltip.offsetHeight - 12) + 'px';
                tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
            } else {
                // Default: below
                tooltip.classList.add('arrow-top');
                tooltip.style.top = (rect.bottom + 12) + 'px';
                tooltip.style.left = (rect.left + rect.width / 2 - tooltip.offsetWidth / 2) + 'px';
            }

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                tooltip.style.transition = 'opacity 0.3s ease';
                tooltip.style.opacity = '0';
                setTimeout(() => {
                    if (tooltip.parentNode) tooltip.parentNode.removeChild(tooltip);
                }, 300);
            }, 5000);
        }

        function showAttachTooltip() {
            showOnboardingTooltip('attachBtn', 'Upload PDF, DOCX, and more', 'top');
        }

        // ========== Main Application ==========

        let currentProject = null;
        let currentConversation = null;
        let currentMessageCitations = [];

        marked.setOptions({ breaks: true, gfm: true });

        // Full-page drag and drop file upload
        const dropOverlay = document.getElementById('dropOverlay');
        let dragCounter = 0;

        document.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            if (currentProject && dragCounter === 1) {
                dropOverlay.classList.add('visible');
            }
        });

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        document.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter <= 0) {
                dragCounter = 0;
                dropOverlay.classList.remove('visible');
            }
        });

        document.addEventListener('drop', async (e) => {
            e.preventDefault();
            dragCounter = 0;
            dropOverlay.classList.remove('visible');

            if (!currentProject) return;

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                await uploadFilesWithProgress(Array.from(files));
            }
        });

        async function loadProjects() {
            const res = await fetch('/api/projects', {
                headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
            });

            if (res.status === 401) {
                authToken = null;
                localStorage.removeItem('authToken');
                showAuthModal();
                return;
            }

            const projects = await res.json();
            const list = document.getElementById('projectsList');
            list.innerHTML = projects.map(p => `
                <div class="project-item" id="project-${p.id}">
                    <div style="display:flex;align-items:center;justify-content:space-between;" onclick="selectProject(${p.id}, '${escapeHtml(p.name)}')">
                        <div>
                            <div class="project-name">${escapeHtml(p.name)}</div>
                            <div class="project-meta">${p.document_count} docs · ${p.conversation_count} chats</div>
                        </div>
                        <div style="margin-left:8px">
                            <button class="conv-menu-btn" onclick="toggleProjectMenu(event, ${p.id})">⋯</button>
                            <div class="conv-menu" id="project-menu-${p.id}">
                                <div class="conv-menu-item" onclick="startRenameProject(event, ${p.id})">✎ Rename</div>
                                <div class="conv-menu-item danger" onclick="deleteProject(event, ${p.id})">🗑 Delete</div>
                            </div>
                        </div>
                    </div>
                    <div class="conversations" id="convs-${p.id}"></div>
                </div>
            `).join('');
        }

        async function selectProject(id, name) {
            currentProject = id;
            currentConversation = null;
            // Clear document selection when switching projects
            _selectedDocIds.clear();
            updateBatchDeleteBar();
            // Hide export button until a conversation is selected
            const exportWrapper = document.getElementById('exportDropdownWrapper');
            if (exportWrapper) exportWrapper.style.display = 'none';

            document.querySelectorAll('.project-item').forEach(el => el.classList.remove('active', 'expanded'));
            document.getElementById(`project-${id}`).classList.add('active', 'expanded');
            document.getElementById('chatTitle').textContent = name;
            document.getElementById('newConvBtn').disabled = false;
            document.getElementById('inputArea').style.display = 'block';

            // Show attach tooltip hint on first project selection
            setTimeout(() => showAttachTooltip(), 800);

            // Load conversations
            const convRes = await fetch(`/api/projects/${id}/conversations`, {
                headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
            });

            if (convRes.status === 401) {
                authToken = null;
                localStorage.removeItem('authToken');
                showAuthModal();
                return;
            }

            const convs = await convRes.json();
            document.getElementById(`convs-${id}`).innerHTML = convs.map(c => `
                <div class="conv-item" onclick="selectConversation(${c.id}, '${escapeHtml(c.title)}'); event.stopPropagation();" id="conv-${c.id}" data-conv-id="${c.id}" data-conv-title="${escapeHtml(c.title)}">
                    <span class="conv-title">${escapeHtml(c.title)}</span>
                    <button class="conv-menu-btn" onclick="toggleConvMenu(event, ${c.id})">⋮</button>
                    <div class="conv-menu" id="conv-menu-${c.id}">
                        <div class="conv-menu-item" onclick="startRenameConv(event, ${c.id})">✎ Rename</div>
                        <div class="conv-menu-item danger" onclick="deleteConversation(event, ${c.id})">🗑 Delete</div>
                    </div>
                </div>
            `).join('');

            // Auto-select the latest conversation so users can start typing immediately
            if (convs && convs.length > 0) {
                // assume conversations are returned oldest->newest; pick the last item as latest
                const latest = convs[convs.length - 1];
                await loadDocuments();
                // select the conversation after DOM insertion and document loading
                await selectConversation(latest.id, latest.title);
                return;
            }
            // If no conversations exist for this project, create the first one automatically
            if (!convs || convs.length === 0) {
                try {
                    const r = await fetch('/api/conversations', {
                        method: 'POST',
                        headers: Object.assign({'Content-Type': 'application/json'}, authToken ? {'Authorization': `Bearer ${authToken}`} : {}),
                        body: JSON.stringify({project_id: currentProject, title: 'New Conversation'})
                    });

                    if (r.status === 401) {
                        authToken = null;
                        localStorage.removeItem('authToken');
                        showAuthModal();
                        return;
                    }
                    if (r.ok) {
                        const created = await r.json();
                        // insert the newly created conversation into the DOM so it can be selected
                        const convsContainer = document.getElementById(`convs-${id}`);
                        if (convsContainer) {
                            convsContainer.innerHTML = `
                                <div class="conv-item" onclick="selectConversation(${created.id}, '${escapeHtml(created.title)}'); event.stopPropagation();" id="conv-${created.id}" data-conv-id="${created.id}" data-conv-title="${escapeHtml(created.title)}">
                                    <span class="conv-title">${escapeHtml(created.title)}</span>
                                    <button class="conv-menu-btn" onclick="toggleConvMenu(event, ${created.id})">⋮</button>
                                    <div class="conv-menu" id="conv-menu-${created.id}">
                                        <div class="conv-menu-item" onclick="startRenameConv(event, ${created.id})">✎ Rename</div>
                                        <div class="conv-menu-item danger" onclick="deleteConversation(event, ${created.id})">🗑 Delete</div>
                                    </div>
                                </div>
                            `;
                        }
                        await loadDocuments();
                        // select the newly created conversation so user can type immediately
                        await selectConversation(created.id, created.title);
                        // return early since selectConversation will enable input and load messages
                        return;
                    }
                } catch (e) {
                    console.warn('Could not auto-create conversation:', e);
                }
            }

            await loadDocuments();

            document.getElementById('messages').innerHTML = `
                <div class="empty-state">
                    <h3>${escapeHtml(name)}</h3>
                    <p>Upload documents and start a conversation</p>
                </div>
            `;
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
        }

        // File type icon helper
        function getFileTypeIcon(filename) {
            const ext = (filename || '').split('.').pop().toLowerCase();
            const icons = {
                pdf: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#dc2626" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#dc2626" stroke-width="1.5" fill="none"/><text x="16" y="20" text-anchor="middle" font-size="8" font-weight="700" fill="#dc2626">PDF</text></svg>',
                doc: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#2563eb" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#2563eb" stroke-width="1.5" fill="none"/><text x="16" y="20" text-anchor="middle" font-size="7" font-weight="700" fill="#2563eb">DOC</text></svg>',
                docx: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#2563eb" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#2563eb" stroke-width="1.5" fill="none"/><text x="16" y="20" text-anchor="middle" font-size="6" font-weight="700" fill="#2563eb">DOCX</text></svg>',
                txt: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#6b7280" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#6b7280" stroke-width="1.5" fill="none"/><line x1="10" y1="11" x2="22" y2="11" stroke="#6b7280" stroke-width="1.2"/><line x1="10" y1="15" x2="22" y2="15" stroke="#6b7280" stroke-width="1.2"/><line x1="10" y1="19" x2="18" y2="19" stroke="#6b7280" stroke-width="1.2"/></svg>',
                md: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#6b7280" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#6b7280" stroke-width="1.5" fill="none"/><text x="16" y="20" text-anchor="middle" font-size="8" font-weight="700" fill="#6b7280">MD</text></svg>',
                csv: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#059669" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#059669" stroke-width="1.5" fill="none"/><text x="16" y="20" text-anchor="middle" font-size="8" font-weight="700" fill="#059669">CSV</text></svg>',
                json: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#059669" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#059669" stroke-width="1.5" fill="none"/><text x="16" y="20" text-anchor="middle" font-size="7" font-weight="700" fill="#059669">{ }</text></svg>',
                pptx: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#ea580c" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#ea580c" stroke-width="1.5" fill="none"/><text x="16" y="20" text-anchor="middle" font-size="7" font-weight="700" fill="#ea580c">PPT</text></svg>',
                ppt: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#ea580c" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#ea580c" stroke-width="1.5" fill="none"/><text x="16" y="20" text-anchor="middle" font-size="7" font-weight="700" fill="#ea580c">PPT</text></svg>',
                html: '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#8b5cf6" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#8b5cf6" stroke-width="1.5" fill="none"/><text x="16" y="20" text-anchor="middle" font-size="6" font-weight="700" fill="#8b5cf6">&lt;/&gt;</text></svg>',
            };
            const defaultIcon = '<svg width="36" height="36" viewBox="0 0 32 32" fill="none"><rect x="6" y="3" width="20" height="26" rx="3" fill="#9ca3af" opacity="0.12"/><rect x="6" y="3" width="20" height="26" rx="3" stroke="#9ca3af" stroke-width="1.5" fill="none"/><line x1="10" y1="11" x2="22" y2="11" stroke="#9ca3af" stroke-width="1.2"/><line x1="10" y1="15" x2="22" y2="15" stroke="#9ca3af" stroke-width="1.2"/><line x1="10" y1="19" x2="18" y2="19" stroke="#9ca3af" stroke-width="1.2"/></svg>';
            return icons[ext] || defaultIcon;
        }

        // Debounce timer for document search
        let _docSearchTimer = null;

        function onDocSearchInput() {
            clearTimeout(_docSearchTimer);
            _docSearchTimer = setTimeout(() => loadDocuments(), 300);
        }

        function setDocFilter(btn) {
            document.querySelectorAll('.doc-filter-pill').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            loadDocuments();
        }

        function onDocFilterChange() {
            loadDocuments();
        }

        function scrollDocCarousel(dir) {
            const strip = document.getElementById('docChips');
            if (!strip) return;
            strip.scrollBy({ left: dir * 280, behavior: 'smooth' });
        }

        function updateCarouselButtons() {
            const strip = document.getElementById('docChips');
            const left = document.getElementById('docCarouselLeft');
            const right = document.getElementById('docCarouselRight');
            if (!strip || !left || !right) return;
            const canLeft = strip.scrollLeft > 0;
            const canRight = strip.scrollLeft + strip.clientWidth < strip.scrollWidth - 1;
            left.classList.toggle('visible', canLeft);
            right.classList.toggle('visible', canRight);
        }

        // Multi-select document state
        const _selectedDocIds = new Set();

        async function loadDocuments() {
            // Build query params for search/filter
            let url = `/api/projects/${currentProject}/documents`;
            const params = new URLSearchParams();

            const searchInput = document.getElementById('docSearchInput');

            if (searchInput && searchInput.value.trim()) {
                params.set('search', searchInput.value.trim());
            }

            const queryString = params.toString();
            if (queryString) {
                url += '?' + queryString;
            }

            const docRes = await fetch(url, {
                headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
            });

            if (docRes.status === 401) {
                authToken = null;
                localStorage.removeItem('authToken');
                showAuthModal();
                return;
            }

            const docs = await docRes.json();

            // Show filter bar and carousel wrapper if there are documents
            const filterBar = document.getElementById('docFilterBar');
            const carouselWrapper = document.getElementById('docCarouselWrapper');
            const hasDocsOrFilter = docs.length > 0 || (searchInput && searchInput.value);
            if (filterBar) filterBar.style.display = hasDocsOrFilter ? 'flex' : 'none';
            if (carouselWrapper) carouselWrapper.style.display = docs.length > 0 ? 'block' : 'none';

            let html = '';
            docs.forEach(d => {
                const s = d.status;
                const statusKey = s === 'ready' ? 'ready' : s === 'processing' ? 'processing' : s === 'error' || s === 'failed' ? 'error' : 'queued';
                const statusLabel = s === 'ready' ? 'ready' : s === 'processing' ? 'processing' : s === 'error' || s === 'failed' ? 'failed' : 'queued';
                const fileIcon = getFileTypeIcon(d.filename);
                const actionsHTML = `<div class="doc-card-actions">${
                    (s === 'error' || s === 'failed') ? `<button onclick="event.stopPropagation();reprocessDoc(${d.id})" title="Reprocess">&#x21bb;</button>` : ''
                }<button onclick="event.stopPropagation();showDocStats(${d.id})" title="Stats"><svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="8" cy="8" r="7"/><line x1="8" y1="7" x2="8" y2="12"/><circle cx="8" cy="4.5" r="0.5" fill="currentColor" stroke="none"/></svg></button></div>`;

                const isSelected = _selectedDocIds.has(d.id);
                html += `<div class="input-doc-chip${isSelected ? ' doc-selected' : ''}" data-doc-id="${d.id}">
                    <input type="checkbox" class="doc-select-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation();toggleDocSelect(${d.id}, this)" title="Select">
                    ${actionsHTML}
                    <span class="input-doc-chip-icon">${fileIcon}</span>
                    <span class="input-doc-chip-name" title="${escapeHtml(d.filename)}">${escapeHtml(d.filename)}</span>
                    <div class="doc-card-status">
                        <span class="doc-status-dot ${statusKey}"></span>
                        <span class="doc-status-label">${statusLabel}</span>
                    </div>
                </div>`;
            });
            const chipsEl = document.getElementById('docChips');
            chipsEl.innerHTML = html;

            // Update carousel nav buttons after render
            requestAnimationFrame(() => updateCarouselButtons());
            chipsEl.onscroll = updateCarouselButtons;

            // Poll for documents that are still processing
            const processing = docs.filter(d => d.status === 'queued' || d.status === 'processing');
            if (processing.length > 0) {
                setTimeout(() => loadDocuments(), 3000);  // Poll every 3s
            }
        }

        async function selectConversation(id, title) {
            currentConversation = id;
            document.querySelectorAll('.conv-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`conv-${id}`).classList.add('active');
            document.getElementById('chatTitle').textContent = title;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            // Show export button when a conversation is selected
            const exportWrapper = document.getElementById('exportDropdownWrapper');
            if (exportWrapper) exportWrapper.style.display = 'inline-block';

            const res = await fetch(`/api/conversations/${id}/messages`, {
                headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
            });

            if (res.status === 401) {
                authToken = null;
                localStorage.removeItem('authToken');
                showAuthModal();
                return;
            }

            const messages = await res.json();
            await renderMessages(messages);
        }

        async function renderMessages(messages) {
            const container = document.getElementById('messages');
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>New Conversation</h3>
                        <p>Ask a question about your documents</p>
                    </div>
                `;
                return;
            }
            container.innerHTML = messages.map(m => {
                const content = m.role === 'assistant'
                    ? marked.parse(m.content)
                    : `<p>${escapeHtml(m.content)}</p>`;
                const roleName = m.role === 'user' ? 'You' : 'Assistant';
                const feedbackHTML = m.role === 'assistant' ? buildFeedbackHTML(m.id, m.feedback) : '';
                return `
                    <div class="message ${m.role}" data-message-id="${m.id}">
                        <div class="message-header">
                            <div class="message-avatar">${m.role === 'user' ? 'U' : 'AI'}</div>
                            <div class="message-role">${roleName}</div>
                        </div>
                        <div class="message-content">${content}</div>
                        ${feedbackHTML}
                    </div>
                `;
            }).join('');

            // Load citations for assistant messages (from database)
            for (const m of messages) {
                if (m.role === 'assistant' && m.id) {
                    const messageDiv = container.querySelector(`[data-message-id="${m.id}"]`);
                    try {
                        const citRes = await fetch(`/api/messages/${m.id}/citations`, {
                            headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                        });
                        if (citRes.ok) {
                            const citations = await citRes.json();
                            if (citations && citations.length > 0) {
                                if (messageDiv) {
                                    addStoredSourcesSection(messageDiv, citations);
                                }
                            } else if (messageDiv) {
                                // Add no-sources warning for historical messages without citations
                                const warning = document.createElement('div');
                                warning.className = 'no-sources-warning';
                                warning.innerHTML = `
                                    <span class="warning-icon">&#9888;&#65039;</span>
                                    <span class="warning-text">This response is based on general knowledge and may not be verified against your documents.</span>
                                `;
                                messageDiv.appendChild(warning);
                            }
                        }
                    } catch (e) {
                        console.error('Failed to load citations for message', m.id, e);
                    }
                }
            }

            container.scrollTop = container.scrollHeight;
        }

        function addStoredSourcesSection(messageDiv, citations) {
            // Format stored citations similar to live citations
            const formattedCitations = citations.map((c, idx) => ({
                citation_number: c.position || idx + 1,
                chunk_id: c.chunk_id,
                document_id: c.document_id,
                document_name: c.document_name || c.filename,
                relevance_score: c.relevance_score,
                page_number: c.page_number,
                content_preview: c.content ? (c.content.length > 200 ? c.content.substring(0, 200) + '...' : c.content) : ''
            }));
            addSourcesSection(messageDiv, formattedCitations);
        }

        async function newConversation() {
            if (!currentProject) return;
            const res = await fetch('/api/conversations', {
                method: 'POST',
                headers: Object.assign({'Content-Type': 'application/json'}, authToken ? {'Authorization': `Bearer ${authToken}`} : {}),
                body: JSON.stringify({project_id: currentProject, title: 'New Conversation'})
            });

            if (res.status === 401) {
                authToken = null;
                localStorage.removeItem('authToken');
                showAuthModal();
                return;
            }
            const conv = await res.json();
            selectProject(currentProject, document.getElementById('chatTitle').textContent);
            setTimeout(() => selectConversation(conv.id, conv.title), 100);
        }

        async function sendMessage() {
            if (!currentConversation) return;
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.style.height = 'auto';
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;

            const container = document.getElementById('messages');
            if (container.querySelector('.empty-state')) {
                container.innerHTML = '';
            }

            // Create user message element
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar">U</div>
                    <div class="message-role">You</div>
                </div>
                <div class="message-content"><p>${escapeHtml(message)}</p></div>
            `;
            container.appendChild(userMsg);

            // Create assistant message element
            const assistantMsg = document.createElement('div');
            assistantMsg.className = 'message assistant';
            assistantMsg.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar">AI</div>
                    <div class="message-role">Assistant</div>
                </div>
                <div class="message-content"><span class="typing-cursor"></span></div>
            `;
            container.appendChild(assistantMsg);

            // Get direct reference to the content element we just created
            const contentEl = assistantMsg.querySelector('.message-content');

            // Force browser reflow to ensure DOM is fully rendered before streaming
            container.offsetHeight;
            container.scrollTop = container.scrollHeight;

            // Small delay to ensure visual update completes
            await new Promise(resolve => setTimeout(resolve, 10));

            // Reset citations for new message
            currentMessageCitations = [];
            let streamedMessageId = null;

            let fullContent = '';
            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: Object.assign({'Content-Type': 'application/json'}, authToken ? {'Authorization': `Bearer ${authToken}`} : {}),
                    body: JSON.stringify({conversation_id: currentConversation, message})
                });

                if (res.status === 401) {
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showAuthModal();
                    return;
                }

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let currentEvent = null;

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.slice(7).trim();
                        } else if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                currentEvent = null;
                                continue;
                            }

                            try {
                                const parsed = JSON.parse(data);

                                if (currentEvent === 'citations') {
                                    // Handle citations event
                                    if (parsed.citations && Array.isArray(parsed.citations)) {
                                        currentMessageCitations = parsed.citations;
                                    }
                                    currentEvent = null;
                                } else if (currentEvent === 'faithfulness') {
                                    // Handle faithfulness score event
                                    const badge = document.createElement('span');
                                    badge.className = `faithfulness-badge ${parsed.level}`;
                                    const icon = parsed.level === 'high' ? '\u2713' : parsed.level === 'medium' ? '~' : '!';
                                    badge.innerHTML = `<span class="faith-icon">${icon}</span> ${parsed.level.charAt(0).toUpperCase() + parsed.level.slice(1)} confidence`;
                                    badge.title = parsed.reason;

                                    const header = assistantMsg.querySelector('.message-header');
                                    if (header) {
                                        header.appendChild(badge);
                                    }
                                    currentEvent = null;
                                } else if (currentEvent === 'message_id') {
                                    // Capture message ID for feedback buttons
                                    if (parsed.message_id) {
                                        streamedMessageId = parsed.message_id;
                                        assistantMsg.dataset.messageId = parsed.message_id;
                                    }
                                    currentEvent = null;
                                } else {
                                    // Handle regular content stream
                                    if (parsed.type === 'title' && parsed.title) {
                                        updateConversationTitle(currentConversation, parsed.title);
                                        continue;
                                    }
                                    if (parsed.content) {
                                        fullContent += parsed.content;
                                        contentEl.innerHTML = marked.parse(fullContent) + '<span class="typing-cursor"></span>';
                                        container.scrollTop = container.scrollHeight;
                                    }
                                }
                            } catch (e) {
                                console.error('Parse error:', e);
                            }
                        } else if (line.trim() === '') {
                            // Empty line resets event
                            currentEvent = null;
                        }
                    }
                }

                // Final render with citations
                let renderedContent = marked.parse(fullContent);
                if (currentMessageCitations && currentMessageCitations.length > 0) {
                    renderedContent = parseInlineCitations(renderedContent, currentMessageCitations);
                }
                contentEl.innerHTML = renderedContent;

                // Add sources section if citations exist, otherwise show warning
                if (currentMessageCitations && currentMessageCitations.length > 0) {
                    addSourcesSection(assistantMsg, currentMessageCitations);
                } else {
                    // Add no-sources warning
                    const existingWarning = assistantMsg.querySelector('.no-sources-warning');
                    if (!existingWarning) {
                        const warning = document.createElement('div');
                        warning.className = 'no-sources-warning';
                        warning.innerHTML = `
                            <span class="warning-icon">&#9888;&#65039;</span>
                            <span class="warning-text">This response is based on general knowledge and may not be verified against your documents.</span>
                        `;
                        assistantMsg.appendChild(warning);
                    }
                }
            } catch (e) {
                console.error('Chat error:', e);
                contentEl.innerHTML = '<p style="color:#dc2626">Error: Could not get response</p>';
            }

            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            input.focus();
        }

        /**
         * Called by the file input's onchange event.
         * Collects selected files and delegates to uploadFilesWithProgress.
         */
        async function uploadFiles() {
            if (!currentProject) return;
            const fileInput = document.getElementById('fileInput');
            const files = Array.from(fileInput.files);
            if (files.length === 0) return;

            await uploadFilesWithProgress(files);
            fileInput.value = '';
        }

        /**
         * Upload multiple files silently. Each file is uploaded via fetch,
         * then documents are reloaded to show them in the card grid.
         */
        async function uploadFilesWithProgress(files) {
            if (!currentProject || files.length === 0) return;

            const uploadPromises = files.map(file => {
                const formData = new FormData();
                formData.append('files', file);
                return fetch(`/api/projects/${currentProject}/upload`, {
                    method: 'POST',
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {},
                    body: formData,
                }).then(r => ({ success: r.ok, file: file.name }))
                  .catch(() => ({ success: false, file: file.name }));
            });

            await Promise.all(uploadPromises);
            await loadDocuments();
        }

        /** Legacy single-file upload (kept for backward compatibility) */
        async function uploadFile() {
            if (!currentProject) return;
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) return;
            await uploadFilesWithProgress([file]);
            fileInput.value = '';
        }

        async function retryDoc(docId) {
            try {
                const res = await fetch(`/api/documents/${docId}/retry`, {
                    method: 'POST',
                    headers: authToken ? {'Authorization': `Bearer ${authToken}`} : {}
                });

                if (res.status === 401) {
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showAuthModal();
                    return;
                }
                if (res.ok) {
                    await loadDocuments();  // Reload to show queued status
                } else {
                    const err = await res.json();
                    alert('Retry failed: ' + (err.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Retry error: ' + e.message);
            }
        }

        async function reprocessDoc(docId) {
            if (!confirm('Reprocess this document from scratch? Existing chunks will be deleted.')) return;
            try {
                const res = await fetch(`/api/documents/${docId}/reprocess`, {
                    method: 'POST',
                    headers: authToken ? {'Authorization': `Bearer ${authToken}`} : {}
                });

                if (res.status === 401) {
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showAuthModal();
                    return;
                }
                if (res.ok) {
                    await loadDocuments();
                } else {
                    const err = await res.json();
                    alert('Reprocess failed: ' + (err.detail || 'Unknown error'));
                }
            } catch (e) {
                alert('Reprocess error: ' + e.message);
            }
        }

        async function showDocStats(docId) {
            try {
                const res = await fetch(`/api/documents/${docId}/stats`, {
                    headers: authToken ? {'Authorization': `Bearer ${authToken}`} : {}
                });

                if (res.status === 401) {
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showAuthModal();
                    return;
                }
                if (!res.ok) {
                    const err = await res.json();
                    alert('Could not load stats: ' + (err.detail || 'Unknown error'));
                    return;
                }

                const stats = await res.json();

                // Build stats display
                let statsHTML = `<strong style="display:block;word-break:break-all;overflow-wrap:break-word;">${escapeHtml(stats.filename)}</strong><br>`;
                statsHTML += `<b>Status:</b> ${escapeHtml(stats.status)}<br>`;
                statsHTML += `<b>File type:</b> ${escapeHtml(stats.file_type || 'N/A')}<br>`;
                statsHTML += `<b>File size:</b> ${escapeHtml(stats.file_size_display)}<br>`;
                statsHTML += `<b>Chunks:</b> ${stats.chunk_count}<br>`;
                statsHTML += `<b>Pages:</b> ${stats.page_count || 'N/A'}<br>`;

                if (stats.processing_time_seconds !== null) {
                    statsHTML += `<b>Processing time:</b> ${stats.processing_time_seconds}s<br>`;
                }
                if (stats.uploaded_at) {
                    statsHTML += `<b>Uploaded:</b> ${new Date(stats.uploaded_at).toLocaleString()}<br>`;
                }
                if (stats.error_message) {
                    statsHTML += `<br><b style="color:#dc2626;">Error:</b> ${escapeHtml(stats.error_message)}<br>`;
                }

                // Show in a simple alert-style dialog (reuse project modal pattern)
                const modal = document.getElementById('projectModal');
                const modalContent = modal.querySelector('.modal-content');
                const origHTML = modalContent.innerHTML;

                modalContent.innerHTML = `
                    <h3>Document Stats</h3>
                    <div style="font-size:14px;line-height:1.8;color:var(--text-secondary);">${statsHTML}</div>
                    <div class="modal-actions">
                        <button class="btn-cancel" onclick="hideModal(); restoreProjectModal();">Close</button>
                    </div>
                `;
                modal.classList.add('show');

                // Store original modal content for restoration
                window._origProjectModalHTML = origHTML;
            } catch (e) {
                alert('Stats error: ' + e.message);
            }
        }

        function restoreProjectModal() {
            if (window._origProjectModalHTML) {
                const modal = document.getElementById('projectModal');
                const modalContent = modal.querySelector('.modal-content');
                modalContent.innerHTML = window._origProjectModalHTML;
                window._origProjectModalHTML = null;
            }
        }

        async function deleteDoc(id) {
            if (!confirm('Delete this document?')) return;
            const res = await fetch(`/api/documents/${id}`, {
                method: 'DELETE',
                headers: authToken ? {'Authorization': `Bearer ${authToken}`} : {}
            });

            if (res.status === 401) {
                authToken = null;
                localStorage.removeItem('authToken');
                showAuthModal();
                return;
            }

            _selectedDocIds.delete(id);
            updateBatchDeleteBar();
            await loadDocuments();
        }

        // --- Multi-select document deletion --- (functions below, Set declared before loadDocuments)

        function toggleDocSelect(docId, checkbox) {
            const chip = checkbox.closest('.input-doc-chip');
            if (checkbox.checked) {
                _selectedDocIds.add(docId);
                chip.classList.add('doc-selected');
            } else {
                _selectedDocIds.delete(docId);
                chip.classList.remove('doc-selected');
            }
            updateBatchDeleteBar();
            updateSelectAllBtn();
        }

        function updateBatchDeleteBar() {
            const bar = document.getElementById('batchActions');
            const countEl = document.getElementById('batchCount');
            if (_selectedDocIds.size > 0) {
                bar.classList.add('visible');
                countEl.textContent = _selectedDocIds.size + ' selected';
            } else {
                bar.classList.remove('visible');
            }
        }

        function updateSelectAllBtn() {
            const btn = document.getElementById('docSelectAllBtn');
            if (!btn) return;
            const allChips = document.querySelectorAll('.input-doc-chip[data-doc-id]');
            const allSelected = allChips.length > 0 && _selectedDocIds.size === allChips.length;
            if (allSelected) {
                btn.textContent = 'Deselect All';
                btn.classList.add('active');
            } else {
                btn.textContent = 'Select All';
                btn.classList.remove('active');
            }
        }

        function toggleSelectAllDocs() {
            const allChips = document.querySelectorAll('.input-doc-chip[data-doc-id]');
            const allSelected = allChips.length > 0 && _selectedDocIds.size === allChips.length;
            if (allSelected) {
                // Deselect all
                clearDocSelection();
            } else {
                // Select all
                allChips.forEach(chip => {
                    const docId = parseInt(chip.getAttribute('data-doc-id'));
                    _selectedDocIds.add(docId);
                    chip.classList.add('doc-selected');
                    const cb = chip.querySelector('.doc-select-checkbox');
                    if (cb) cb.checked = true;
                });
                updateBatchDeleteBar();
                updateSelectAllBtn();
            }
        }

        function clearDocSelection() {
            _selectedDocIds.clear();
            document.querySelectorAll('.input-doc-chip.doc-selected').forEach(chip => {
                chip.classList.remove('doc-selected');
                const cb = chip.querySelector('.doc-select-checkbox');
                if (cb) cb.checked = false;
            });
            updateBatchDeleteBar();
            updateSelectAllBtn();
        }

        async function batchDeleteSelected() {
            if (_selectedDocIds.size === 0) return;
            const count = _selectedDocIds.size;
            if (!confirm('Delete ' + count + ' document' + (count !== 1 ? 's' : '') + '? This cannot be undone.')) return;

            const ids = Array.from(_selectedDocIds).map(id => parseInt(id, 10));
            try {
                const res = await fetch('/api/documents/batch?ids=' + ids.join(','), {
                    method: 'DELETE',
                    headers: authToken ? {'Authorization': 'Bearer ' + authToken} : {}
                });

                if (res.status === 401) {
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showAuthModal();
                    return;
                }

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    const detail = Array.isArray(err.detail) ? err.detail.map(d => d.msg).join(', ') : (err.detail || 'Unknown error');
                    alert('Batch delete failed: ' + detail);
                    return;
                }

                const result = await res.json();
                _selectedDocIds.clear();
                updateBatchDeleteBar();
                updateSelectAllBtn();
                await loadDocuments();
            } catch (e) {
                alert('Batch delete failed: ' + e.message);
            }
        }

        // Delete key to delete selected documents
        document.addEventListener('keydown', (e) => {
            if ((e.key === 'Delete' || e.key === 'Backspace') && _selectedDocIds.size > 0) {
                const active = document.activeElement;
                if (active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) return;
                e.preventDefault();
                batchDeleteSelected();
            }
        });

        function showNewProjectModal() {
            document.getElementById('projectModal').classList.add('show');
            document.getElementById('projectName').focus();
        }

        function hideModal() {
            document.getElementById('projectModal').classList.remove('show');
            document.getElementById('projectName').value = '';
            document.getElementById('projectDesc').value = '';
        }

        async function createProject() {
                const name = document.getElementById('projectName').value.trim();
                if (!name) return;
                const desc = document.getElementById('projectDesc').value.trim();

                const res = await fetch('/api/projects', {
                    method: 'POST',
                    headers: Object.assign({'Content-Type': 'application/json'}, authToken ? {'Authorization': `Bearer ${authToken}`} : {}),
                    body: JSON.stringify({name, description: desc || null})
                });

                if (res.status === 401) {
                    authToken = null;
                    localStorage.removeItem('authToken');
                    showAuthModal();
                    return;
                }
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert('Failed to create project: ' + (err.detail || res.statusText));
                    return;
                }
                const proj = await res.json();
                hideModal();
                await loadProjects();
                // Auto-select the newly created project (which will create and select the first conversation)
                await selectProject(proj.id, proj.name);
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function parseInlineCitations(html, citations) {
            return html.replace(/\[(\d+)\]/g, (match, num) => {
                const idx = parseInt(num, 10);
                const citation = citations.find(c => c.citation_number === idx);
                if (citation) {
                    const preview = escapeHtml(citation.content_preview || '').replace(/'/g, '&#39;');
                    return `<span class="inline-citation"
                        data-citation-num="${idx}"
                        data-chunk-id="${citation.chunk_id}"
                        data-preview="${preview}"
                        onclick="viewCitation(${citation.chunk_id}, '${escapeHtml(citation.document_name).replace(/'/g, "\\'")}', ${citation.relevance_score})"
                        onmouseenter="showCitationTooltip(event, this)"
                        onmouseleave="hideCitationTooltip()">[${num}]</span>`;
                }
                return match;
            });
        }

        function updateConversationTitle(convId, newTitle) {
            const convItem = document.getElementById(`conv-${convId}`);
            if (convItem) {
                convItem.dataset.convTitle = newTitle;
                const titleSpan = convItem.querySelector('.conv-title');
                if (titleSpan) titleSpan.textContent = newTitle;
            }
            if (currentConversation === convId) {
                document.getElementById('chatTitle').textContent = newTitle;
            }
        }

        function toggleConvMenu(event, convId) {
            event.stopPropagation();
            document.querySelectorAll('.conv-menu').forEach(m => m.classList.remove('show'));
            document.getElementById(`conv-menu-${convId}`).classList.toggle('show');
        }

        function toggleProjectMenu(event, projectId) {
            event.stopPropagation();
            // hide any open menus
            document.querySelectorAll('.conv-menu').forEach(m => m.classList.remove('show'));
            const el = document.getElementById(`project-menu-${projectId}`);
            if (el) el.classList.toggle('show');
        }

        document.addEventListener('click', () => {
            document.querySelectorAll('.conv-menu').forEach(m => m.classList.remove('show'));
        });

        function startRenameProject(event, projectId) {
            event.stopPropagation();
            document.querySelectorAll('.conv-menu').forEach(m => m.classList.remove('show'));

            const projItem = document.getElementById(`project-${projectId}`);
            const nameEl = projItem.querySelector('.project-name');
            const currentName = nameEl.textContent;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'conv-rename-input';
            input.value = currentName;
            nameEl.replaceWith(input);
            input.focus();
            input.select();

            const saveRename = async () => {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    const res = await fetch(`/api/projects/${projectId}`, {
                        method: 'PUT',
                        headers: Object.assign({'Content-Type': 'application/json'}, authToken ? {'Authorization': `Bearer ${authToken}`} : {}),
                        body: JSON.stringify({name: newName})
                    });

                    if (res.status === 401) {
                        authToken = null;
                        localStorage.removeItem('authToken');
                        showAuthModal();
                        return;
                    }
                    if (currentProject === projectId) {
                        document.getElementById('chatTitle').textContent = newName;
                    }
                }
                const span = document.createElement('div');
                span.className = 'project-name';
                span.textContent = newName || currentName;
                input.replaceWith(span);
                // update projects list metadata (reload projects) for consistency
                await loadProjects();
            };

            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
                else if (e.key === 'Escape') { input.value = currentName; input.blur(); }
            });
        }

        async function deleteProject(event, projectId) {
            event.stopPropagation();
            document.querySelectorAll('.conv-menu').forEach(m => m.classList.remove('show'));
            if (!confirm('Delete this project and all its data?')) return;

            const res = await fetch(`/api/projects/${projectId}`, {
                method: 'DELETE',
                headers: authToken ? {'Authorization': `Bearer ${authToken}`} : {}
            });

            if (res.status === 401) {
                authToken = null;
                localStorage.removeItem('authToken');
                showAuthModal();
                return;
            }
            if (currentProject === projectId) {
                currentProject = null;
                currentConversation = null;
                document.getElementById('messages').innerHTML = `
                    <div class="empty-state">
                        <h3>Project deleted</h3>
                        <p>Select or create a project to get started</p>
                    </div>
                `;
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            }
            document.getElementById(`project-${projectId}`)?.remove();
            // reload projects to keep list consistent
            await loadProjects();
        }

        function startRenameConv(event, convId) {
            event.stopPropagation();
            document.querySelectorAll('.conv-menu').forEach(m => m.classList.remove('show'));

            const convItem = document.getElementById(`conv-${convId}`);
            const titleSpan = convItem.querySelector('.conv-title');
            const currentTitle = convItem.dataset.convTitle;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'conv-rename-input';
            input.value = currentTitle;
            titleSpan.replaceWith(input);
            input.focus();
            input.select();

            const saveRename = async () => {
                const newTitle = input.value.trim();
                if (newTitle && newTitle !== currentTitle) {
                    const res = await fetch(`/api/conversations/${convId}`, {
                        method: 'PUT',
                        headers: Object.assign({'Content-Type': 'application/json'}, authToken ? {'Authorization': `Bearer ${authToken}`} : {}),
                        body: JSON.stringify({title: newTitle})
                    });

                    if (res.status === 401) {
                        authToken = null;
                        localStorage.removeItem('authToken');
                        showAuthModal();
                        return;
                    }
                    convItem.dataset.convTitle = newTitle;
                    if (currentConversation === convId) {
                        document.getElementById('chatTitle').textContent = newTitle;
                    }
                }
                const newSpan = document.createElement('span');
                newSpan.className = 'conv-title';
                newSpan.textContent = input.value.trim() || currentTitle;
                input.replaceWith(newSpan);
            };

            input.addEventListener('blur', saveRename);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
                else if (e.key === 'Escape') { input.value = currentTitle; input.blur(); }
            });
        }

        async function deleteConversation(event, convId) {
            event.stopPropagation();
            document.querySelectorAll('.conv-menu').forEach(m => m.classList.remove('show'));

            if (!confirm('Delete this conversation?')) return;

            const res = await fetch(`/api/conversations/${convId}`, {
                method: 'DELETE',
                headers: authToken ? {'Authorization': `Bearer ${authToken}`} : {}
            });

            if (res.status === 401) {
                authToken = null;
                localStorage.removeItem('authToken');
                showAuthModal();
                return;
            }

            if (currentConversation === convId) {
                currentConversation = null;
                document.getElementById('messages').innerHTML = `
                    <div class="empty-state">
                        <h3>Conversation deleted</h3>
                        <p>Start a new conversation</p>
                    </div>
                `;
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            }

            document.getElementById(`conv-${convId}`)?.remove();
        }

        // ========== Citation Functions ==========

        // Source panel state
        let sourcePanelCitations = [];
        let sourcePanelCurrentIndex = 0;
        let sourcePanelOpen = false;

        function addSourcesSection(messageDiv, citations) {
            // Remove existing sources section if any
            const existingSources = messageDiv.querySelector('.sources-section');
            if (existingSources) {
                existingSources.remove();
            }

            const sourcesHTML = `
                <div class="sources-section">
                    <div class="sources-header">Sources</div>
                    ${citations.map(citation => `
                        <div class="source-item" onclick="viewCitation(event, ${citation.chunk_id}, '${escapeHtml(citation.document_name)}', ${citation.relevance_score}, ${citation.page_number || 'null'})">
                            <div class="source-header">
                                <span class="source-number">[${citation.citation_number}]</span>
                                <span class="source-doc-name">${escapeHtml(citation.document_name)}${citation.page_number ? ` (p. ${citation.page_number})` : ''}</span>
                                <span class="source-score">Score: ${(citation.relevance_score * 100).toFixed(0)}%</span>
                            </div>
                            <div class="source-preview">${escapeHtml(citation.content_preview)}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            messageDiv.insertAdjacentHTML('beforeend', sourcesHTML);

            // Store citations on the message element for panel navigation
            messageDiv._citations = citations;
        }

        function showCitationTooltip(event, element) {
            const tooltip = document.getElementById('citationTooltip');
            const preview = element.dataset.preview;
            const citNum = element.dataset.citationNum;

            if (!preview) return;

            const previewText = preview.length > 200 ? preview.substring(0, 200) + '...' : preview;
            tooltip.innerHTML = `
                <div class="citation-tooltip-header">Source [${citNum}]</div>
                <div class="citation-tooltip-content">${previewText}</div>
            `;

            const rect = element.getBoundingClientRect();
            tooltip.style.left = `${Math.max(10, rect.left - 50)}px`;
            tooltip.style.top = `${rect.top - tooltip.offsetHeight - 10}px`;

            // Reposition if off-screen
            setTimeout(() => {
                const tooltipRect = tooltip.getBoundingClientRect();
                if (tooltipRect.right > window.innerWidth - 10) {
                    tooltip.style.left = `${window.innerWidth - tooltipRect.width - 10}px`;
                }
                if (tooltipRect.top < 10) {
                    tooltip.style.top = `${rect.bottom + 10}px`;
                }
            }, 0);

            tooltip.classList.add('visible');
        }

        function hideCitationTooltip() {
            const tooltip = document.getElementById('citationTooltip');
            if (tooltip) {
                tooltip.classList.remove('visible');
            }
        }

        async function viewCitation(eventOrChunkId, chunkIdOrDocName, docNameOrScore, scoreOrPage, pageNumberArg) {
            // Support both signatures:
            //   viewCitation(event, chunkId, docName, score, page) - from source items
            //   viewCitation(chunkId, docName, score, page)        - from inline badges
            let evt = null;
            let chunkId, documentName, relevanceScore, pageNumber;

            if (typeof eventOrChunkId === 'object' && eventOrChunkId !== null && eventOrChunkId.target) {
                evt = eventOrChunkId;
                chunkId = chunkIdOrDocName;
                documentName = docNameOrScore;
                relevanceScore = scoreOrPage;
                pageNumber = pageNumberArg || null;
            } else {
                chunkId = eventOrChunkId;
                documentName = chunkIdOrDocName;
                relevanceScore = docNameOrScore;
                pageNumber = scoreOrPage || null;
            }

            // On mobile, use modal fallback
            if (window.innerWidth < 768) {
                await viewCitationModal(chunkId, documentName, relevanceScore, pageNumber);
                return;
            }

            // On desktop, use the side panel
            try {
                const response = await fetch(`/api/chunks/${chunkId}`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });

                if (!response.ok) throw new Error('Failed to load citation');

                const chunk = await response.json();
                const displayPageNumber = pageNumber || chunk.page_number;

                // Find parent message citations for panel navigation
                const targetEl = evt ? evt.target : null;
                const messageEl = findParentMessage(targetEl);
                if (messageEl && messageEl._citations && messageEl._citations.length > 0) {
                    sourcePanelCitations = messageEl._citations;
                    const idx = sourcePanelCitations.findIndex(c => c.chunk_id === chunkId);
                    sourcePanelCurrentIndex = idx >= 0 ? idx : 0;
                } else if (typeof currentMessageCitations !== 'undefined' && currentMessageCitations && currentMessageCitations.length > 0) {
                    sourcePanelCitations = currentMessageCitations;
                    const idx = sourcePanelCitations.findIndex(c => c.chunk_id === chunkId);
                    sourcePanelCurrentIndex = idx >= 0 ? idx : 0;
                } else {
                    sourcePanelCitations = [{ chunk_id: chunkId, document_name: documentName, relevance_score: relevanceScore, page_number: displayPageNumber, citation_number: 1 }];
                    sourcePanelCurrentIndex = 0;
                }

                renderSourcePanel(chunk, documentName, relevanceScore, displayPageNumber);
                openSourcePanel();

            } catch (error) {
                console.error('Failed to view citation:', error);
                alert('Failed to load citation details');
            }
        }

        async function viewCitationModal(chunkId, documentName, relevanceScore, pageNumber) {
            try {
                const response = await fetch(`/api/chunks/${chunkId}`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
                if (!response.ok) throw new Error('Failed to load citation');
                const chunk = await response.json();
                const displayPageNumber = pageNumber || chunk.page_number;

                document.getElementById('citationModalBody').innerHTML = `
                    <div class="citation-full-text">${escapeHtml(chunk.content)}</div>
                    <div class="citation-meta">
                        <div class="citation-meta-item"><span class="citation-meta-label">Document:</span> ${escapeHtml(documentName)}</div>
                        ${displayPageNumber ? `<div class="citation-meta-item"><span class="citation-meta-label">Page:</span> ${displayPageNumber}</div>` : ''}
                        <div class="citation-meta-item"><span class="citation-meta-label">Chunk Index:</span> ${chunk.chunk_index}</div>
                        <div class="citation-meta-item"><span class="citation-meta-label">Relevance Score:</span> ${(relevanceScore * 100).toFixed(1)}%</div>
                    </div>
                `;
                document.getElementById('citationModal').classList.add('active');
            } catch (error) {
                console.error('Failed to view citation:', error);
                alert('Failed to load citation details');
            }
        }

        function renderSourcePanel(chunk, documentName, relevanceScore, pageNumber) {
            document.getElementById('sourcePanelTitle').textContent = documentName;
            const scorePercent = (relevanceScore * 100).toFixed(1);
            const scoreClass = relevanceScore >= 0.7 ? 'score-high' : relevanceScore >= 0.4 ? 'score-medium' : 'score-low';

            document.getElementById('sourcePanelBody').innerHTML = `
                <div class="source-panel-doc-info">
                    <div class="source-panel-doc-row"><span class="source-panel-doc-label">Filename</span><span class="source-panel-doc-value">${escapeHtml(documentName)}</span></div>
                    ${pageNumber ? `<div class="source-panel-doc-row"><span class="source-panel-doc-label">Page</span><span class="source-panel-doc-value">${pageNumber}</span></div>` : ''}
                    <div class="source-panel-doc-row"><span class="source-panel-doc-label">Chunk</span><span class="source-panel-doc-value">#${chunk.chunk_index}</span></div>
                </div>
                <div class="source-panel-score">
                    <div class="source-panel-score-label"><span>Relevance Score</span><span class="source-panel-score-value">${scorePercent}%</span></div>
                    <div class="source-panel-score-bar"><div class="source-panel-score-fill ${scoreClass}" style="width: ${scorePercent}%"></div></div>
                </div>
                <div class="source-panel-content-label">Source Text</div>
                <div class="source-panel-chunk-text">${escapeHtml(chunk.content)}</div>
            `;
            updateSourcePanelNav();
        }

        function updateSourcePanelNav() {
            const nav = document.getElementById('sourcePanelNav');
            if (sourcePanelCitations.length <= 1) { nav.style.display = 'none'; return; }
            nav.style.display = 'flex';
            document.getElementById('sourcePanelPrev').disabled = sourcePanelCurrentIndex <= 0;
            document.getElementById('sourcePanelNext').disabled = sourcePanelCurrentIndex >= sourcePanelCitations.length - 1;
            document.getElementById('sourcePanelIndicator').textContent = `${sourcePanelCurrentIndex + 1} of ${sourcePanelCitations.length}`;
        }

        async function navigateSourcePanel(direction) {
            const newIndex = sourcePanelCurrentIndex + direction;
            if (newIndex < 0 || newIndex >= sourcePanelCitations.length) return;
            sourcePanelCurrentIndex = newIndex;
            const citation = sourcePanelCitations[newIndex];
            try {
                const response = await fetch(`/api/chunks/${citation.chunk_id}`, {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
                if (!response.ok) throw new Error('Failed to load citation');
                const chunk = await response.json();
                renderSourcePanel(chunk, citation.document_name, citation.relevance_score, citation.page_number || chunk.page_number);
            } catch (error) {
                console.error('Failed to navigate citation:', error);
            }
        }

        function openSourcePanel() {
            document.getElementById('sourcePanel').classList.add('open');
            document.getElementById('sourcePanelOverlay').classList.add('active');
            sourcePanelOpen = true;
        }

        function closeSourcePanel() {
            document.getElementById('sourcePanel').classList.remove('open');
            document.getElementById('sourcePanelOverlay').classList.remove('active');
            sourcePanelOpen = false;
        }

        function findParentMessage(el) {
            if (!el) return null;
            let current = el;
            while (current) {
                if (current.classList && current.classList.contains('message')) return current;
                current = current.parentElement;
            }
            return null;
        }

        function closeCitationModal() {
            document.getElementById('citationModal').classList.remove('active');
        }

        document.addEventListener('click', (e) => {
            const modal = document.getElementById('citationModal');
            if (e.target === modal) closeCitationModal();
        });

        // ========== Feedback Functions ==========

        function buildFeedbackHTML(messageId, existingFeedback) {
            const posSelected = existingFeedback === 'positive' ? 'selected positive' : (existingFeedback === 'negative' ? 'dimmed' : '');
            const negSelected = existingFeedback === 'negative' ? 'selected negative' : (existingFeedback === 'positive' ? 'dimmed' : '');
            const hasFeedback = existingFeedback ? 'has-feedback' : '';

            return `
                <div class="feedback-row ${hasFeedback}" data-msg-id="${messageId}">
                    <button class="feedback-btn ${posSelected}" onclick="submitFeedback(${messageId}, 'positive', this)" title="Helpful">&#x1F44D;</button>
                    <button class="feedback-btn ${negSelected}" onclick="submitFeedback(${messageId}, 'negative', this)" title="Not helpful">&#x1F44E;</button>
                    ${existingFeedback ? '<span class="feedback-thanks">Thanks for your feedback</span>' : ''}
                </div>
            `;
        }

        async function submitFeedback(messageId, feedback, btnEl) {
            try {
                const res = await fetch(`/api/messages/${messageId}/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
                    },
                    body: JSON.stringify({ feedback })
                });

                if (!res.ok) throw new Error('Failed to submit feedback');

                // Update UI
                const row = btnEl.closest('.feedback-row');
                row.classList.add('has-feedback');
                const btns = row.querySelectorAll('.feedback-btn');
                btns.forEach(b => {
                    b.className = 'feedback-btn';
                    b.classList.add('dimmed');
                });
                btnEl.className = `feedback-btn selected ${feedback}`;

                // Add thanks message
                let thanks = row.querySelector('.feedback-thanks');
                if (!thanks) {
                    thanks = document.createElement('span');
                    thanks.className = 'feedback-thanks';
                    thanks.textContent = 'Thanks for your feedback';
                    row.appendChild(thanks);
                }
            } catch (err) {
                console.error('Feedback error:', err);
            }
        }

        // ========== Model Selector Functions ==========

        let modelData = null;

        async function loadModels() {
            try {
                const res = await fetch('/api/models', {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
                if (!res.ok) return;
                modelData = await res.json();
                renderModelSelector();
            } catch (e) {
                console.error('Failed to load models:', e);
            }
        }

        function renderModelSelector() {
            const select = document.getElementById('modelSelector');
            if (!modelData || !select) return;

            select.innerHTML = '';
            const providers = modelData.providers;

            for (const [provName, info] of Object.entries(providers)) {
                if (!info.available) continue;
                const group = document.createElement('optgroup');
                group.label = provName.charAt(0).toUpperCase() + provName.slice(1);

                for (const m of info.models) {
                    const opt = document.createElement('option');
                    opt.value = `${provName}:${m}`;
                    opt.textContent = m;
                    if (provName === modelData.current_provider && m === modelData.current_model) {
                        opt.selected = true;
                    }
                    group.appendChild(opt);
                }
                select.appendChild(group);
            }

            select.style.display = 'inline-block';
        }

        async function switchModel() {
            const select = document.getElementById('modelSelector');
            const val = select.value;
            if (!val) return;

            const [provider, model] = val.split(':');
            try {
                const res = await fetch('/api/models/select', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
                    },
                    body: JSON.stringify({ provider, model })
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert('Failed to switch model: ' + (err.detail || 'Unknown error'));
                    loadModels(); // reset selector
                    return;
                }

                modelData.current_provider = provider;
                modelData.current_model = model;
            } catch (e) {
                console.error('Model switch error:', e);
            }
        }

        // ========== Analytics Dashboard Functions ==========

        let analyticsCharts = {};

        function toggleAnalyticsView() {
            const av = document.getElementById('analyticsView');
            const main = document.getElementById('mainView');
            const btn = document.getElementById('analyticsNavBtn');

            if (av.classList.contains('active')) {
                // Hide analytics, show main
                av.classList.remove('active');
                main.classList.remove('hidden-for-analytics');
                btn.classList.remove('active');
            } else {
                // Show analytics, hide main
                av.classList.add('active');
                main.classList.add('hidden-for-analytics');
                btn.classList.add('active');
                loadAnalyticsData();
            }
        }

        async function loadAnalyticsData() {
            const content = document.getElementById('analyticsContent');
            content.innerHTML = '<div class="analytics-loading">Loading analytics...</div>';

            try {
                const res = await fetch('/api/analytics', {
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {}
                });
                if (!res.ok) throw new Error('Failed to load analytics');
                const data = await res.json();
                renderAnalyticsDashboard(data);
            } catch (e) {
                content.innerHTML = '<div class="analytics-empty"><h3>Unable to load analytics</h3><p>' + e.message + '</p></div>';
            }
        }

        function renderAnalyticsDashboard(data) {
            const content = document.getElementById('analyticsContent');
            const s = data.summary;
            const latencyDisplay = s.avg_latency_ms ? (s.avg_latency_ms / 1000).toFixed(1) + 's' : 'N/A';

            content.innerHTML = `
                <div class="analytics-cards">
                    <div class="analytics-card">
                        <div class="analytics-card-icon docs">D</div>
                        <div class="analytics-card-value">${s.total_documents}</div>
                        <div class="analytics-card-label">Documents</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-icon chunks">C</div>
                        <div class="analytics-card-value">${s.total_chunks}</div>
                        <div class="analytics-card-label">Chunks</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-icon queries">Q</div>
                        <div class="analytics-card-value">${s.total_queries}</div>
                        <div class="analytics-card-label">Queries</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-icon latency">L</div>
                        <div class="analytics-card-value">${latencyDisplay}</div>
                        <div class="analytics-card-label">Avg Response Time</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-card-icon convs">C</div>
                        <div class="analytics-card-value">${s.total_conversations}</div>
                        <div class="analytics-card-label">Conversations</div>
                    </div>
                </div>

                <div class="analytics-charts">
                    <div class="analytics-chart-box">
                        <h4>Queries Per Day (Last 30 Days)</h4>
                        <canvas id="queriesChart"></canvas>
                    </div>
                    <div class="analytics-chart-box">
                        <h4>Document Types</h4>
                        <canvas id="docTypesChart"></canvas>
                    </div>
                </div>

                <div class="analytics-table-box">
                    <h4>Top Cited Documents</h4>
                    ${data.top_cited_documents.length > 0 ? `
                    <table class="analytics-table">
                        <thead><tr><th>#</th><th>Document</th><th>Citations</th></tr></thead>
                        <tbody>
                            ${data.top_cited_documents.map((d, i) => `
                                <tr><td>${i + 1}</td><td>${escapeHtml(d.filename)}</td><td>${d.citation_count}</td></tr>
                            `).join('')}
                        </tbody>
                    </table>` : '<p style="color:var(--text-muted);font-size:13px;">No citations yet</p>'}
                </div>

                <div class="analytics-table-box">
                    <h4>Processing Status</h4>
                    <div class="analytics-processing">
                        <div class="processing-stat completed">
                            <div class="processing-stat-value">${data.processing_stats.completed}</div>
                            <div class="processing-stat-label">Completed</div>
                        </div>
                        <div class="processing-stat failed">
                            <div class="processing-stat-value">${data.processing_stats.failed}</div>
                            <div class="processing-stat-label">Failed</div>
                        </div>
                        <div class="processing-stat processing">
                            <div class="processing-stat-value">${data.processing_stats.processing}</div>
                            <div class="processing-stat-label">Processing</div>
                        </div>
                        <div class="processing-stat queued">
                            <div class="processing-stat-value">${data.processing_stats.queued}</div>
                            <div class="processing-stat-label">Queued</div>
                        </div>
                    </div>
                </div>
            `;

            // Render charts
            renderQueriesChart(data.queries_per_day);
            renderDocTypesChart(data.document_types);
        }

        function renderQueriesChart(queriesPerDay) {
            const ctx = document.getElementById('queriesChart');
            if (!ctx) return;

            if (analyticsCharts.queries) analyticsCharts.queries.destroy();

            analyticsCharts.queries = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: queriesPerDay.map(d => d.date),
                    datasets: [{
                        label: 'Queries',
                        data: queriesPerDay.map(d => d.count),
                        backgroundColor: 'rgba(255, 138, 0, 0.7)',
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } },
                        x: { ticks: { maxTicksLimit: 10 } }
                    }
                }
            });
        }

        function renderDocTypesChart(documentTypes) {
            const ctx = document.getElementById('docTypesChart');
            if (!ctx) return;

            if (analyticsCharts.docTypes) analyticsCharts.docTypes.destroy();

            const colors = ['#2563eb', '#ff8a00', '#059669', '#7c3aed', '#db2777', '#d97706', '#dc2626'];

            analyticsCharts.docTypes = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: documentTypes.map(d => d.type.toUpperCase()),
                    datasets: [{
                        data: documentTypes.map(d => d.count),
                        backgroundColor: colors.slice(0, documentTypes.length),
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        // Load models on auth
        const _origOnLogin = typeof onLoginSuccess === 'function' ? onLoginSuccess : null;
        function onAuthReady() {
            loadModels();
        }
        // Hook into auth flow - load models after token is available
        const _checkModelsInterval = setInterval(() => {
            if (authToken) {
                clearInterval(_checkModelsInterval);
                loadModels();
            }
        }, 500);

        // ========== Export Functions ==========

        function toggleExportDropdown(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('show');

            // Close on outside click
            function closeDropdown(e) {
                if (!e.target.closest('.export-dropdown-wrapper')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            }
            if (dropdown.classList.contains('show')) {
                setTimeout(() => document.addEventListener('click', closeDropdown), 0);
            }
        }

        function exportConversation(format) {
            if (!currentConversation) return;
            document.getElementById('exportDropdown').classList.remove('show');

            const url = '/api/conversations/' + currentConversation + '/export?format=' + format;
            const a = document.createElement('a');
            // Use fetch to include auth header, then trigger download
            fetch(url, {
                headers: authToken ? { 'Authorization': 'Bearer ' + authToken } : {}
            }).then(res => {
                if (!res.ok) throw new Error('Export failed');
                const disposition = res.headers.get('Content-Disposition') || '';
                const filenameMatch = disposition.match(/filename="?([^"]+)"?/);
                const filename = filenameMatch ? filenameMatch[1] : ('conversation.' + format);
                return res.blob().then(blob => ({ blob, filename }));
            }).then(({ blob, filename }) => {
                const blobUrl = URL.createObjectURL(blob);
                a.href = blobUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(blobUrl);
            }).catch(e => {
                console.error('Export error:', e);
                alert('Failed to export conversation: ' + e.message);
            });
        }

    </script>
</body>
</html>
